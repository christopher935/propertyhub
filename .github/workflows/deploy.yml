name: Deploy to Digital Ocean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Droplet
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build PropertyHub for Linux
        run: |
          echo "ğŸ”¨ Building PropertyHub..."
          GOOS=linux GOARCH=amd64 CGO_ENABLED=1 go build \
            -ldflags="-w -s -X main.Version=${{ github.sha }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o propertyhub-server \
            ./cmd/server
          
          chmod +x propertyhub-server
          ls -lh propertyhub-server
          echo "âœ… Build complete"

      - name: Deploy to Digital Ocean
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          DB_PASSWORD: ${{ secrets.DO_DB_PASSWORD }}
        run: |
          echo "ğŸ” Configuring SSH..."
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 209.38.116.238 >> ~/.ssh/known_hosts
          
          echo "ğŸ“¤ Uploading fresh files to droplet..."
          scp -i ~/.ssh/deploy_key propertyhub-server root@209.38.116.238:/opt/propertyhub/propertyhub-server.new
          
          echo "ğŸ“¤ Syncing files to droplet (with cleanup of orphaned files)..."
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" web/templates/ root@209.38.116.238:/opt/propertyhub/web/templates/
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" web/static/ root@209.38.116.238:/opt/propertyhub/web/static/
          
          echo "ğŸ“¦ Uploading database migrations..."
          scp -i ~/.ssh/deploy_key -r internal/database/migrations root@209.38.116.238:/opt/propertyhub/
          
          echo "ğŸ—„ï¸ Running database migrations..."
          ssh -i ~/.ssh/deploy_key root@209.38.116.238 << ENDSSH
            export PGPASSWORD="$DB_PASSWORD"
            
            echo "Applying migrations..."
            for migration in /opt/propertyhub/migrations/*.sql; do
              if [ -f "\$migration" ]; then
                echo "  â†’ \$(basename \$migration)"
                psql -h llot-db-do-user-24934977-0.e.db.ondigitalocean.com \
                     -p 25060 \
                     -U doadmin \
                     -d defaultdb \
                     -f "\$migration" 2>&1 | grep -v "already exists" || true
              fi
            done
            
            echo "âœ… Migrations complete"
          ENDSSH
          
          echo "ğŸ”„ Deploying application..."
          ssh -i ~/.ssh/deploy_key root@209.38.116.238 << 'ENDSSH'
            cd /opt/propertyhub
            
            echo "ğŸ—‘ï¸ Removing ALL old backup binaries (they contain bugs)..."
            rm -f propertyhub.backup.* 2>/dev/null || true
            
            echo "ğŸ“¦ Installing new binary..."
            mv propertyhub-server.new propertyhub-server
            chmod +x propertyhub-server
            
            echo "ğŸ”„ Restarting service..."
            systemctl restart propertyhub
            sleep 8
            
            echo "ğŸ“‹ Server status:"
            systemctl status propertyhub --no-pager || true
            
            echo "ğŸ“‹ Last 30 lines of server logs:"
            journalctl -u propertyhub -n 30 --no-pager || true
          ENDSSH
          
          echo "âœ… Deployed and restarted"

      - name: Health Check
        run: |
          echo "ğŸ¥ Running health check..."
          for i in {1..10}; do
            RESPONSE=$(curl -s http://209.38.116.238:8080/health || echo "")
            if echo "$RESPONSE" | grep -q '"status":"ok"'; then
              echo "âœ… Health check PASSED!"
              echo "Response: $RESPONSE"
              exit 0
            fi
            echo "â³ Attempt $i/10... waiting"
            sleep 3
          done
          echo "âŒ Health check failed after 10 attempts"
          exit 1

      # DISABLED - rollback was restoring buggy old binaries
      # - name: Rollback on Failure
      #   if: failure()
      #   env:
      #     SSH_PRIVATE_KEY: ${{ secrets.DO_SSH_PRIVATE_KEY }}
      #   run: |
      #     echo "ğŸ”„ Rolling back..."
      #     ssh -i ~/.ssh/deploy_key root@209.38.116.238 << 'ENDSSH'
      #       cd /opt/propertyhub
      #       LATEST=$(ls -t propertyhub.backup.* 2>/dev/null | head -n 1)
      #       if [ -n "$LATEST" ]; then
      #         cp $LATEST propertyhub
      #         systemctl restart propertyhub
      #         echo "âœ… Rolled back to previous version"
      #       fi
      #     ENDSSH
