name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...

  gosec:
    name: Security Scanner (gosec)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

  staticcheck:
    name: Static Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install staticcheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run staticcheck
        run: staticcheck ./...

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  security-audit:
    name: Security Audit Summary
    runs-on: ubuntu-latest
    needs: [govulncheck, gosec, staticcheck]
    if: always()
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security Audit Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| govulncheck | ${{ needs.govulncheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| gosec | ${{ needs.gosec.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| staticcheck | ${{ needs.staticcheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.govulncheck.result }}" == "failure" ]] || \
             [[ "${{ needs.gosec.result }}" == "failure" ]] || \
             [[ "${{ needs.staticcheck.result }}" == "failure" ]]; then
            echo "âŒ **Security scan failed!** Please review the findings above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the detailed scan results in the job logs" >> $GITHUB_STEP_SUMMARY
            echo "2. Address high and critical severity issues immediately" >> $GITHUB_STEP_SUMMARY
            echo "3. Create tickets for medium/low severity issues" >> $GITHUB_STEP_SUMMARY
            echo "4. Re-run scans after fixes are applied" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All security scans passed!**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: |
          (needs.govulncheck.result == 'failure' || 
           needs.gosec.result == 'failure' || 
           needs.staticcheck.result == 'failure') &&
          github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Security Scan Failed - ' + new Date().toISOString().split('T')[0];
            const body = `## Security Scan Failure Report
            
            **Date:** ${new Date().toUTCString()}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Workflow:** ${{ github.workflow }}
            
            ### Failed Scans
            
            | Scanner | Status |
            |---------|--------|
            | govulncheck | ${{ needs.govulncheck.result }} |
            | gosec | ${{ needs.gosec.result }} |
            | staticcheck | ${{ needs.staticcheck.result }} |
            
            ### Action Required
            
            One or more security scans have failed. Please review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            
            **Priority:** High
            **Type:** Security
            
            ### Steps to Resolve
            
            1. Review the detailed scan results in the workflow logs
            2. Address high and critical severity issues immediately
            3. Update dependencies if vulnerabilities are in dependencies
            4. Fix code issues identified by gosec or staticcheck
            5. Re-run the security scan workflow
            6. Close this issue once all scans pass
            
            ---
            
            *This issue was automatically created by the security scan workflow.*`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated', 'high-priority']
            });

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
