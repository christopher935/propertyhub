{% extends "layouts/admin-base.html" %}

{% block additional_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
{% endblock %}

{% block layout_data %}

{% endblock %}

{% block content %}
<div class="section">
    <div class="flex justify-between align-center mb-6">
        <div>
            <h2 class="text-2xl font-semibold text-navy-primary">Showing Calendar</h2>
            <p class="text-gray-500">Manage property showings and appointments</p>
        </div>
        <button class="btn btn-primary" @click="showAddBookingModal = true">+ Schedule Showing</button>
    </div>
    
    <div class="card p-6">
        <div id="calendar"></div>
    </div>
</div>

<div class="modal-overlay" x-show="showAddBookingModal" @click="showAddBookingModal = false" x-transition style="display: none;">
    <div class="modal" @click.stop>
        <div class="modal-header">
            <h3>Schedule New Showing</h3>
            <button class="modal-close" @click="showAddBookingModal = false">Ã—</button>
        </div>
        <div class="modal-body">
            <form @submit.prevent="createBooking">
                <div class="form-group">
                    <label class="form-label">Property</label>
                    <select x-model="newBooking.property_id" required class="form-input">
                        <option value="">Select Property</option>
                        <template x-for="property in properties" :key="property.id">
                            <option :value="property.id" x-text="property.address"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Lead</label>
                    <select x-model="newBooking.lead_id" required class="form-input">
                        <option value="">Select Lead</option>
                        <template x-for="lead in leads" :key="lead.id">
                            <option :value="lead.id" x-text="lead.name"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date & Time</label>
                    <input type="datetime-local" x-model="newBooking.scheduled_at" required class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea x-model="newBooking.notes" rows="3" class="form-input"></textarea>
                </div>
                <div class="flex gap-3 justify-end">
                    <button type="button" class="btn btn-secondary" @click="showAddBookingModal = false">Cancel</button>
                    <button type="submit" class="btn btn-primary">Schedule Showing</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function calendarData() {
        return {
            showAddBookingModal: false,
            calendar: null,
            properties: [],
            leads: [],
            newBooking: {
                property_id: '',
                lead_id: '',
                scheduled_at: '',
                notes: ''
            },
            
            async init() {
                await Promise.all([
                    this.fetchProperties(),
                    this.fetchLeads()
                ]);
                this.initCalendar();
            },
            
            initCalendar() {
                const calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    events: '/api/v1/bookings/calendar',
                    eventClick: (info) => {
                        window.location.href = `/admin/booking-detail/${info.event.id}`;
                    }
                });
                this.calendar.render();
            },
            
            async fetchProperties() {
                try {
                    const response = await fetch('/api/properties?status=active');
                    if (response.ok) {
                        this.properties = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch properties:', error);
                }
            },
            
            async fetchLeads() {
                try {
                    const response = await fetch('/api/leads');
                    if (response.ok) {
                        this.leads = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch leads:', error);
                }
            },
            
            async createBooking() {
                try {
                    const response = await fetch('/api/v1/bookings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newBooking)
                    });
                    
                    if (response.ok) {
                        this.showAddBookingModal = false;
                        this.calendar.refetchEvents();
                        this.newBooking = { property_id: '', lead_id: '', scheduled_at: '', notes: '' };
                    } else {
                        alert('Failed to create booking');
                    }
                } catch (error) {
                    alert('An error occurred');
                }
            }
        };
    }
</script>
{% endblock %}
