{% extends "layouts/admin-base.html" %}

{% block layout_data %}x-data="feedbackData()" x-init="init()"{% endblock %}

{% block content %}
<div class="card p-6 mb-6">
    <div class="stats-grid-4">
        <div class="text-center">
            <div class="text-3xl font-bold text-navy-primary" x-text="stats.total"></div>
            <div class="text-sm text-gray-500">Total Feedback</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-success" x-text="stats.average_rating.toFixed(1)"></div>
            <div class="text-sm text-gray-500">Average Rating</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-gold-primary" x-text="stats.positive"></div>
            <div class="text-sm text-gray-500">Positive Reviews</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-error" x-text="stats.needs_response"></div>
            <div class="text-sm text-gray-500">Needs Response</div>
        </div>
    </div>
</div>

<div class="card p-6">
    <div class="flex justify-between align-center mb-4">
        <div class="flex gap-3">
            <select x-model="filterRating" @change="applyFilters" class="form-input">
                <option value="">All Ratings</option>
                <option value="5">5 Stars</option>
                <option value="4">4 Stars</option>
                <option value="3">3 Stars</option>
                <option value="2">2 Stars</option>
                <option value="1">1 Star</option>
            </select>
            
            <select x-model="filterStatus" @change="applyFilters" class="form-input">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="responded">Responded</option>
                <option value="resolved">Resolved</option>
            </select>
        </div>
    </div>
    
    <div x-show="loading" class="d-flex justify-center p-6">
        <div class="loading"></div>
    </div>
    
    <div x-show="!loading">
        <div class="d-grid gap-4">
            <template x-for="feedback in filteredFeedback" :key="feedback.id">
                <div class="p-4 border border-gray-200 rounded-md cursor-pointer transition" 
                     @click="window.location.href = '/admin/feedback-detail/' + feedback.id"
                     @mouseenter="$el.style.transform='translateY(-2px)'; $el.style.boxShadow='var(--shadow-md)'"
                     @mouseleave="$el.style.transform='translateY(0)'; $el.style.boxShadow='none'">
                    <div class="flex justify-between align-start mb-3">
                        <div class="flex-1">
                            <div class="flex align-center gap-2 mb-2">
                                <span class="font-semibold text-navy-primary" x-text="feedback.customer_name"></span>
                                <div class="flex align-center">
                                    <template x-for="i in 5" :key="i">
                                        <svg width="16" height="16" :fill="i <= feedback.rating ? 'var(--gold-primary)' : 'var(--gray-300)'" viewBox="0 0 24 24">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        </svg>
                                    </template>
                                </div>
                            </div>
                            <p class="text-gray-600 mb-2" x-text="feedback.comment"></p>
                            <div class="flex gap-3 text-sm text-gray-500">
                                <span x-text="'Property: ' + feedback.property_address"></span>
                                <span>â€¢</span>
                                <span x-text="new Date(feedback.created_at).toLocaleDateString()"></span>
                            </div>
                        </div>
                        <span class="status-badge" :class="'status-' + feedback.status" x-text="feedback.status"></span>
                    </div>
                </div>
            </template>
            
            <div x-show="filteredFeedback.length === 0" class="text-center p-8 text-gray-500">
                <svg width="64" height="64" class="mx-auto mb-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z"></path>
                </svg>
                <p class="font-medium">No feedback found</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function feedbackData() {
        return {
            loading: true,
            feedback: [],
            searchQuery: '',
            filterRating: '',
            filterStatus: '',
            stats: {
                total: 0,
                average_rating: 0,
                positive: 0,
                needs_response: 0
            },
            
            get filteredFeedback() {
                let filtered = this.feedback;
                
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    filtered = filtered.filter(f => 
                        f.customer_name.toLowerCase().includes(query) ||
                        f.comment.toLowerCase().includes(query) ||
                        f.property_address.toLowerCase().includes(query)
                    );
                }
                
                if (this.filterRating) {
                    filtered = filtered.filter(f => f.rating === parseInt(this.filterRating));
                }
                
                if (this.filterStatus) {
                    filtered = filtered.filter(f => f.status === this.filterStatus);
                }
                
                return filtered;
            },
            
            async init() {
                await Promise.all([
                    this.fetchFeedback(),
                    this.fetchStats()
                ]);
                this.loading = false;
            },
            
            async fetchFeedback() {
                try {
                    const response = await fetch('/api/admin/feedback');
                    if (response.ok) {
                        this.feedback = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch feedback:', error);
                }
            },
            
            async fetchStats() {
                try {
                    const response = await fetch('/api/admin/feedback/stats');
                    if (response.ok) {
                        this.stats = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch stats:', error);
                }
            },
            
            applyFilters() {
            },
            
            performSearch() {
            }
        };
    }
</script>
{% endblock %}
