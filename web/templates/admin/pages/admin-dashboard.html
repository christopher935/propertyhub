<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <title>Dashboard - PropertyHub</title>
    <link rel="stylesheet" href="/static/css/admin-design-tokens.css">
    <link rel="stylesheet" href="/static/css/admin-scout-utilities.css">
    <link rel="stylesheet" href="/static/css/admin-scout-layouts.css">
    <link rel="stylesheet" href="/static/css/scout-components-admin.css">
    <link rel="stylesheet" href="/static/css/dashboard-interactions.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="/static/js/ux-enhancements.js"></script>
</head>
<body>
    <div class="admin-layout" x-data="dashboardData()" x-init="init()">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <a href="/admin/dashboard" class="sidebar-logo">
                    <div class="sidebar-logo-icon">PH</div>
                    <span>PropertyHub</span>
                </a>
            </div>
            
            <nav class="admin-sidebar-nav">
                <div class="nav-section expanded">
                    <a href="/admin/dashboard" class="nav-section-header active">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                        <span class="nav-section-title">Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-section" x-data="{ open: false }">
                    <button class="nav-section-header" @click="open = !open">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                        <span class="nav-section-title">Leads</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.total_leads || 0"></span>
                        <svg class="w-4 h-4 nav-section-toggle transition" :class="{ 'rotate-90': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <ul class="nav-section-items" x-show="open" x-collapse>
                        <li><a href="/admin/leads" class="nav-item">All Leads <span class="nav-item-badge" x-text="sidebarCounts.total_leads || 0"></span></a></li>
                        <li><a href="/admin/leads?segment=hot" class="nav-item">Hot Leads <span class="nav-item-badge" x-text="sidebarCounts.hot_leads || 0"></span></a></li>
                        <li><a href="/admin/leads?segment=warm" class="nav-item">Warm Leads <span class="nav-item-badge" x-text="sidebarCounts.warm_leads || 0"></span></a></li>
                        <li><a href="/admin/communication" class="nav-item">Communication Center</a></li>
                    </ul>
                </div>
                
                <div class="nav-section" x-data="{ open: false }">
                    <button class="nav-section-header" @click="open = !open">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></div>
                        <span class="nav-section-title">Properties</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.active_properties || 0"></span>
                        <svg class="w-4 h-4 nav-section-toggle transition" :class="{ 'rotate-90': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <ul class="nav-section-items" x-show="open" x-collapse>
                        <li><a href="/admin/properties" class="nav-item">All Properties</a></li>
                        <li><a href="/admin/properties?status=active" class="nav-item">Active Listings</a></li>
                        <li><a href="/admin/properties?status=pending_images" class="nav-item">Pending Images <span class="nav-item-badge" x-text="sidebarCounts.pending_images || 0"></span></a></li>
                        <li><a href="/admin/pre-listing" class="nav-item">Pre-Listing Pipeline</a></li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <a href="/admin/applications" class="nav-section-header">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                        <span class="nav-section-title">Applications</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.pending_applications || 0"></span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <a href="/admin/bookings" class="nav-section-header">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>
                        <span class="nav-section-title">Bookings</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.confirmed_bookings || 0"></span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <a href="/admin/closing-pipeline" class="nav-section-header">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg></div>
                        <span class="nav-section-title">Closing Pipeline</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.closing_pipeline || 0"></span>
                    </a>
                </div>
                
                <div class="nav-section" x-data="{ open: false }">
                    <button class="nav-section-header" @click="open = !open">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></div>
                        <span class="nav-section-title">Intelligence</span>
                        <svg class="w-4 h-4 nav-section-toggle transition" :class="{ 'rotate-90': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <ul class="nav-section-items" x-show="open" x-collapse>
                        <li><a href="/admin/business-intelligence" class="nav-item">Business Intelligence</a></li>
                        <li><a href="/admin/behavioral-intelligence" class="nav-item">Behavioral Analytics</a></li>
                        <li><a href="/admin/market-intelligence" class="nav-item">Market Intelligence</a></li>
                    </ul>
                </div>
                
                <div class="nav-section" x-data="{ open: false }">
                    <button class="nav-section-header" @click="open = !open">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
                        <span class="nav-section-title">System</span>
                        <svg class="w-4 h-4 nav-section-toggle transition" :class="{ 'rotate-90': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <ul class="nav-section-items" x-show="open" x-collapse>
                        <li><a href="/admin/settings" class="nav-item">Settings</a></li>
                        <li><a href="/admin/rbac" class="nav-item">Roles & Permissions</a></li>
                        <li><a href="/admin/integrations/webhooks" class="nav-item">Integrations</a></li>
                        <li><a href="/admin/security" class="nav-item">Security Monitoring</a></li>
                    </ul>
                </div>
            </nav>
        </aside>
        
        <main class="admin-main">
            <header class="admin-header">
                <div class="admin-header-content">
                    <h1 class="admin-header-title">Dashboard</h1>
                    
                    <div class="admin-header-actions">
                        <div class="admin-search">
                            <input type="search" placeholder="Search leads, properties..." x-model="searchQuery" @input.debounce.300ms="performSearch">
                            <svg class="admin-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <div class="admin-user-menu">
                            <div class="admin-user-avatar" x-text="userProfile.initials"></div>
                            <div class="admin-user-info">
                                <div class="admin-user-name" x-text="userProfile.username"></div>
                                <div class="admin-user-role" x-text="userProfile.role"></div>
                            </div>
                        </div>
                        
                        <a href="/admin/logout" class="btn-logout">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </a>
                    </div>
                </div>
            </header>
            
            <div class="admin-content">
                <section class="dashboard-section dashboard-critical" x-show="criticalStats.pendingBookings > 0 || criticalStats.pendingApplications > 0 || criticalStats.alerts > 0">
                    <div class="critical-actions-bar">
                        <div class="critical-item" x-show="criticalStats.pendingBookings > 0">
                            <span class="critical-count" x-text="criticalStats.pendingBookings"></span>
                            <span class="critical-label">Pending Bookings</span>
                            <a href="/admin/bookings" class="critical-link">Review →</a>
                        </div>
                        <div class="critical-item" x-show="criticalStats.pendingApplications > 0">
                            <span class="critical-count" x-text="criticalStats.pendingApplications"></span>
                            <span class="critical-label">Pending Applications</span>
                            <a href="/admin/applications" class="critical-link">Review →</a>
                        </div>
                        <div class="critical-item" x-show="criticalStats.alerts > 0">
                            <span class="critical-count" x-text="criticalStats.alerts"></span>
                            <span class="critical-label">System Alerts</span>
                            <a href="/admin/security" class="critical-link">View →</a>
                        </div>
                    </div>
                </section>

                <section class="dashboard-section">
                    <h2 class="section-title">Key Metrics</h2>
                    <div class="stats-grid stats-grid-4">
                        <div class="stat-card" x-data="statCard('active_leads')">
                            <div class="stat-card-label">Active Leads</div>
                            <div class="stat-card-value" x-text="Math.round(displayValue)"></div>
                            <div class="stat-card-change" :class="keyMetrics.activeLeadsTrend > 0 ? 'positive' : 'negative'">
                                <span x-text="keyMetrics.activeLeadsTrend > 0 ? '↑' : '↓'"></span>
                                <span x-text="Math.abs(keyMetrics.activeLeadsTrend) + '%'"></span>
                            </div>
                        </div>
                        
                        <div class="stat-card" x-data="statCard('conversion_rate')">
                            <div class="stat-card-label">Conversion Rate</div>
                            <div class="stat-card-value" x-text="displayValue.toFixed(1) + '%'"></div>
                            <div class="stat-card-subtitle">30-day average</div>
                        </div>
                        
                        <div class="stat-card" x-data="statCard('revenue_mtd')">
                            <div class="stat-card-label">Revenue MTD</div>
                            <div class="stat-card-value" x-text="formatCurrency(displayValue)"></div>
                            <div class="stat-card-change" :class="keyMetrics.revenueTrend > 0 ? 'positive' : 'negative'">
                                <span x-text="keyMetrics.revenueTrend > 0 ? '↑' : '↓'"></span>
                                <span x-text="Math.abs(keyMetrics.revenueTrend) + '%'"></span>
                            </div>
                        </div>
                        
                        <div class="stat-card" x-data="statCard('bookings_week')">
                            <div class="stat-card-label">Bookings This Week</div>
                            <div class="stat-card-value" x-text="Math.round(displayValue)"></div>
                            <div class="stat-card-subtitle">
                                <span x-text="keyMetrics.confirmedBookings"></span> confirmed
                            </div>
                        </div>
                    </div>
                </section>

                <section class="dashboard-section">
                    <div class="dashboard-columns">
                        <div class="dashboard-column">
                            <div class="d-flex justify-between align-center mb-4">
                                <h2 class="section-title">Top Opportunities</h2>
                                <a href="/admin/business-intelligence" class="view-all">View All →</a>
                            </div>
                            
                            <div x-show="loadingOpportunities" class="d-flex justify-center p-6">
                                <div class="loading"></div>
                            </div>
                            
                            <div x-show="!loadingOpportunities">
                                <template x-for="(opp, index) in opportunities.slice(0, 4)" :key="opp.id">
                                    <div class="opportunity-card mb-3">
                                        <div class="opportunity-header">
                                            <div class="opportunity-rank" x-text="'#' + (index + 1)"></div>
                                            <div class="opportunity-badges">
                                                <span class="badge badge-danger text-xs" x-text="'Priority: ' + opp.priority"></span>
                                                <span class="badge badge-success text-xs" x-text="Math.round(opp.conversion_probability * 100) + '%'"></span>
                                            </div>
                                        </div>
                                        <h4 class="opportunity-title" x-text="opp.lead_name"></h4>
                                        <p class="opportunity-type" x-text="opp.type.replace(/_/g, ' ')"></p>
                                        <div class="opportunity-property" x-show="opp.property_address" x-text="opp.property_address"></div>
                                        <div class="opportunity-actions">
                                            <template x-for="action in opp.action_sequence.slice(0, 2)" :key="action.action">
                                                <button class="btn btn-sm btn-primary" @click="executeAction(opp.id, action.action, opp.lead_email)">
                                                    <span x-text="action.description"></span>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                
                                <div x-show="opportunities.length === 0" class="empty-state-small">
                                    <div class="empty-state-icon">✓</div>
                                    <div class="empty-state-text">No urgent opportunities</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-column">
                            <div class="d-flex justify-between align-center mb-4">
                                <h2 class="section-title">Recent Activity</h2>
                                <a href="/admin/business-intelligence" class="view-all">View All →</a>
                            </div>
                            
                            <div class="activity-feed-compact">
                                <template x-for="activity in recentActivity.slice(0, 5)" :key="activity.id">
                                    <div class="activity-item-compact">
                                        <div class="activity-icon-compact" :style="`background-color: ${getActivityColor(activity.type)}`">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" :d="getActivityIconPath(activity.type)"></path>
                                            </svg>
                                        </div>
                                        <div class="activity-content-compact">
                                            <div class="activity-title-compact" x-text="activity.title"></div>
                                            <div class="activity-time-compact" x-text="formatTimeAgo(activity.timestamp)"></div>
                                        </div>
                                    </div>
                                </template>
                                
                                <div x-show="recentActivity.length === 0" class="empty-state-small">
                                    <div class="empty-state-text">No recent activity</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="dashboard-section">
                    <h2 class="section-title">Performance Overview</h2>
                    <div class="charts-grid charts-grid-2">
                        <div class="chart-card">
                            <div class="chart-card-header">
                                <h3 class="chart-card-title">Booking Trends</h3>
                                <p class="chart-card-subtitle">Last 7 days</p>
                            </div>
                            <div class="chart-card-body">
                                <canvas x-ref="bookingTrendsChart" class="chart-canvas"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-card-header">
                                <h3 class="chart-card-title">Lead Sources</h3>
                                <p class="chart-card-subtitle">Current month</p>
                            </div>
                            <div class="chart-card-body">
                                <canvas x-ref="leadSourceChart" class="chart-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="dashboard-section dashboard-system-status">
                    <div class="system-status-indicator" :class="systemHealthClass">
                        <span class="status-icon">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" :d="systemHealth.status === 'healthy' ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' : 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'"></path>
                            </svg>
                        </span>
                        <div class="status-content">
                            <span class="status-text" x-text="systemHealthText"></span>
                            <span class="status-details" x-text="systemHealth.uptime_percent + '% uptime • ' + systemHealth.avg_response_time_ms + 'ms avg response'"></span>
                        </div>
                        <a href="/admin/security" class="status-link">Details →</a>
                    </div>
                </section>
            </div>
        </main>
        
        <div class="toast-container" x-data="toastManager()">
            <template x-for="toast in toasts" :key="toast.id">
                <div class="toast" :class="`toast-${toast.type}`" x-show="toast.visible" x-transition:enter="transition-fast" x-transition:leave="transition-fast">
                    <div class="toast-icon" x-text="getToastIcon(toast.type)"></div>
                    <div class="toast-message" x-text="toast.message"></div>
                    <button class="toast-close" @click="remove(toast.id)">×</button>
                </div>
            </template>
        </div>
    </div>
    
    <script>
        function dashboardData() {
            return {
                chartColors: {
                    primary: '#1b3559',
                    secondary: '#c4a962',
                    success: '#10B981',
                    warning: '#F59E0B',
                    error: '#EF4444',
                    info: '#3B82F6'
                },
                
                criticalStats: {
                    pendingBookings: 0,
                    pendingApplications: 0,
                    alerts: 0
                },
                
                keyMetrics: {
                    activeLeads: 0,
                    activeLeadsTrend: 0,
                    conversionRate: 0,
                    revenueMTD: 0,
                    revenueTrend: 0,
                    bookingsWeek: 0,
                    confirmedBookings: 0
                },
                
                opportunities: [],
                recentActivity: [],
                
                systemHealth: {
                    status: 'healthy',
                    uptime_percent: 99.9,
                    avg_response_time_ms: 120,
                    error_rate_percent: 0.1
                },
                
                sidebarCounts: {
                    total_leads: 0,
                    hot_leads: 0,
                    warm_leads: 0,
                    active_properties: 0,
                    pending_applications: 0,
                    confirmed_bookings: 0,
                    closing_pipeline: 0,
                    pending_images: 0
                },
                
                userProfile: {
                    username: 'Loading...',
                    role: 'Loading...',
                    initials: 'U'
                },
                
                loadingOpportunities: true,
                searchQuery: '',
                bookingTrendsChart: null,
                leadSourceChart: null,
                
                async init() {
                    await this.fetchUserProfile();
                    await Promise.all([
                        this.fetchCriticalStats(),
                        this.fetchKeyMetrics(),
                        this.fetchOpportunities(),
                        this.fetchRecentActivity(),
                        this.fetchChartData(),
                        this.fetchSystemHealth()
                    ]);
                    this.renderCharts();
                },
                
                async fetchUserProfile() {
                    try {
                        const response = await fetch('/api/admin/settings/profile');
                        const data = await response.json();
                        this.userProfile = {
                            username: data.username || 'User',
                            role: data.role || 'Unknown',
                            initials: this.getUserInitials(data.username)
                        };
                    } catch (error) {
                        console.error('Failed to fetch user profile:', error);
                        this.userProfile = { username: 'User', role: 'Unknown', initials: 'U' };
                    }
                },
                
                getUserInitials(name) {
                    if (!name) return 'U';
                    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                },
                
                async fetchCriticalStats() {
                    try {
                        const response = await fetch('/api/stats/critical');
                        const data = await response.json();
                        this.criticalStats = {
                            pendingBookings: data.pending_bookings || 0,
                            pendingApplications: data.pending_applications || 0,
                            alerts: data.system_alerts || 0
                        };
                        this.sidebarCounts.pending_applications = data.pending_applications || 0;
                    } catch (error) {
                        console.error('Failed to fetch critical stats:', error);
                    }
                },
                
                async fetchKeyMetrics() {
                    try {
                        const response = await fetch('/api/stats/key-metrics');
                        const data = await response.json();
                        this.keyMetrics = {
                            activeLeads: data.active_leads || 0,
                            activeLeadsTrend: data.active_leads_trend || 0,
                            conversionRate: data.conversion_rate || 0,
                            revenueMTD: data.revenue_mtd || 0,
                            revenueTrend: data.revenue_trend || 0,
                            bookingsWeek: data.bookings_week || 0,
                            confirmedBookings: data.confirmed_bookings || 0
                        };
                        this.sidebarCounts.total_leads = data.active_leads || 0;
                        this.sidebarCounts.hot_leads = data.hot_leads || 0;
                        this.sidebarCounts.warm_leads = data.warm_leads || 0;
                        this.sidebarCounts.confirmed_bookings = data.bookings_week || 0;
                    } catch (error) {
                        console.error('Failed to fetch key metrics:', error);
                    }
                },
                
                async fetchOpportunities() {
                    this.loadingOpportunities = true;
                    try {
                        const response = await fetch('/api/stats/opportunities?limit=4');
                        const data = await response.json();
                        this.opportunities = data.opportunities || [];
                    } catch (error) {
                        console.error('Failed to fetch opportunities:', error);
                    } finally {
                        this.loadingOpportunities = false;
                    }
                },
                
                async fetchRecentActivity() {
                    try {
                        const response = await fetch('/api/stats/activity?limit=5');
                        const data = await response.json();
                        this.recentActivity = data.activities || [];
                    } catch (error) {
                        console.error('Failed to fetch recent activity:', error);
                    }
                },
                
                async fetchChartData() {
                    try {
                        const [bookingResponse, leadSourceResponse] = await Promise.all([
                            fetch('/api/charts/bookings'),
                            fetch('/api/charts/lead-sources')
                        ]);
                        
                        this.bookingTrendsData = await bookingResponse.json();
                        this.leadSourceData = await leadSourceResponse.json();
                    } catch (error) {
                        console.error('Failed to fetch chart data:', error);
                    }
                },
                
                async fetchSystemHealth() {
                    try {
                        const response = await fetch('/api/admin/system/health');
                        const data = await response.json();
                        this.systemHealth = {
                            status: data.status || 'healthy',
                            uptime_percent: data.uptime_percent || 99.9,
                            avg_response_time_ms: data.avg_response_time_ms || 120,
                            error_rate_percent: data.error_rate_percent || 0.1
                        };
                        this.sidebarCounts.active_properties = data.active_properties || 0;
                        this.sidebarCounts.pending_images = data.pending_images || 0;
                        this.sidebarCounts.closing_pipeline = data.closing_pipeline || 0;
                    } catch (error) {
                        console.error('Failed to fetch system health:', error);
                    }
                },
                
                renderCharts() {
                    this.$nextTick(() => {
                        this.renderBookingTrendsChart();
                        this.renderLeadSourceChart();
                    });
                },
                
                renderBookingTrendsChart() {
                    const ctx = this.$refs.bookingTrendsChart;
                    if (!ctx) return;
                    
                    if (this.bookingTrendsChart) {
                        this.bookingTrendsChart.destroy();
                    }
                    
                    this.bookingTrendsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.bookingTrendsData?.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Bookings',
                                data: this.bookingTrendsData?.data || [12, 19, 15, 25, 22, 18, 20],
                                borderColor: this.chartColors.primary,
                                backgroundColor: this.chartColors.primary + '20',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                },
                
                renderLeadSourceChart() {
                    const ctx = this.$refs.leadSourceChart;
                    if (!ctx) return;
                    
                    if (this.leadSourceChart) {
                        this.leadSourceChart.destroy();
                    }
                    
                    this.leadSourceChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: this.leadSourceData?.labels || ['Website', 'Referral', 'Social Media', 'Direct'],
                            datasets: [{
                                data: this.leadSourceData?.data || [45, 25, 20, 10],
                                backgroundColor: [
                                    this.chartColors.primary,
                                    this.chartColors.secondary,
                                    this.chartColors.info,
                                    this.chartColors.success
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                },
                
                get systemHealthClass() {
                    if (this.systemHealth.status === 'healthy') return 'healthy';
                    if (this.systemHealth.status === 'warning') return 'warning';
                    return 'critical';
                },
                
                get systemHealthText() {
                    if (this.systemHealth.status === 'healthy') return 'All Systems Operational';
                    if (this.systemHealth.status === 'warning') return 'Minor Issues Detected';
                    return 'Critical Issues Detected';
                },
                
                async executeAction(oppId, action, email) {
                    console.log('Executing action:', action, 'for opportunity:', oppId);
                },
                
                getActivityColor(type) {
                    const colors = {
                        'lead': this.chartColors.info,
                        'booking': this.chartColors.success,
                        'application': this.chartColors.secondary,
                        'message': this.chartColors.primary
                    };
                    return colors[type] || this.chartColors.info;
                },
                
                getActivityIconPath(type) {
                    const paths = {
                        'lead': 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z',
                        'booking': 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z',
                        'application': 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
                        'message': 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z'
                    };
                    return paths[type] || paths.lead;
                },
                
                formatTimeAgo(timestamp) {
                    const now = new Date();
                    const past = new Date(timestamp);
                    const diffInSeconds = Math.floor((now - past) / 1000);
                    
                    if (diffInSeconds < 60) return 'Just now';
                    if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + 'm ago';
                    if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + 'h ago';
                    return Math.floor(diffInSeconds / 86400) + 'd ago';
                },
                
                formatCurrency(value) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(value);
                },
                
                performSearch() {
                    console.log('Searching for:', this.searchQuery);
                }
            };
        }
        
        function statCard(metricName) {
            return {
                displayValue: 0,
                targetValue: 0,
                
                init() {
                    this.$watch(() => {
                        const parent = this.$el.closest('[x-data*="dashboardData"]');
                        if (!parent) return 0;
                        const data = Alpine.$data(parent);
                        
                        switch(metricName) {
                            case 'active_leads': return data.keyMetrics.activeLeads;
                            case 'conversion_rate': return data.keyMetrics.conversionRate;
                            case 'revenue_mtd': return data.keyMetrics.revenueMTD;
                            case 'bookings_week': return data.keyMetrics.bookingsWeek;
                            default: return 0;
                        }
                    }, (newValue) => {
                        this.targetValue = newValue;
                        this.animateValue();
                    });
                },
                
                animateValue() {
                    const duration = 1000;
                    const start = this.displayValue;
                    const end = this.targetValue;
                    const startTime = performance.now();
                    
                    const animate = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        this.displayValue = start + (end - start) * this.easeOutQuart(progress);
                        
                        if (progress < 1) {
                            requestAnimationFrame(animate);
                        }
                    };
                    
                    requestAnimationFrame(animate);
                },
                
                easeOutQuart(x) {
                    return 1 - Math.pow(1 - x, 4);
                }
            };
        }
        
        function toastManager() {
            return {
                toasts: [],
                nextId: 1,
                
                add(message, type = 'info', duration = 5000) {
                    const id = this.nextId++;
                    const toast = { id, message, type, visible: true };
                    this.toasts.push(toast);
                    
                    setTimeout(() => {
                        this.remove(id);
                    }, duration);
                },
                
                remove(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index !== -1) {
                        this.toasts[index].visible = false;
                        setTimeout(() => {
                            this.toasts.splice(index, 1);
                        }, 300);
                    }
                },
                
                getToastIcon(type) {
                    const icons = {
                        success: '✓',
                        error: '✕',
                        warning: '⚠',
                        info: 'ℹ'
                    };
                    return icons[type] || icons.info;
                }
            };
        }
    </script>
</body>
</html>
