        function toastManager() {
            return {
                toasts: [],
                nextId: 1,
                
                add(message, type = 'info', duration = 5000) {
                    const id = this.nextId++;
                    const toast = { id, message, type, visible: true };
                    this.toasts.push(toast);
                    
                    setTimeout(() => {
                        this.remove(id);
                    }, duration);
                },
                
                remove(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index !== -1) {
                        this.toasts[index].visible = false;
                        setTimeout(() => {
                            this.toasts.splice(index, 1);
                        }, 300);
                    }
                },
                
                getToastIcon(type) {
                    const icons = {
                        success: 'âœ“',
                        error: 'âœ•',
                        warning: 'âš ',
                        info: 'â„¹'
                    };
                    return icons[type] || icons.info;
                }
            };
        }
        
        function liveSessionsPanel() {
            return {
                sessions: [],
                loading: true,
                selectedSession: null,
                showJourneyModal: false,
                journeyData: null,
                updateInterval: null,
                
                async init() {
                    await this.fetchSessions();
                    // Poll for updates every 10 seconds
                    this.updateInterval = setInterval(() => {
                        this.fetchSessions();
                    }, 10000);
                },
                
                async fetchSessions() {
                    try {
                        const response = await fetch('/api/admin/sessions/active');
                        const data = await response.json();
                        
                        // Mark new sessions for animation
                        const newSessionIds = data.sessions.map(s => s.session_id);
                        const oldSessionIds = this.sessions.map(s => s.session_id);
                        
                        this.sessions = data.sessions.map(session => {
                            const isNew = !oldSessionIds.includes(session.session_id);
                            return { ...session, isNew };
                        });
                        
                        this.loading = false;
                    } catch (error) {
                        console.error('Failed to fetch sessions:', error);
                        this.loading = false;
                    }
                },
                
                async viewJourney(sessionId) {
                    try {
                        const response = await fetch(`/api/admin/sessions/${sessionId}/journey`);
                        const data = await response.json();
                        this.journeyData = data;
                        this.showJourneyModal = true;
                    } catch (error) {
                        console.error('Failed to fetch session journey:', error);
                    }
                },
                
                closeJourneyModal() {
                    this.showJourneyModal = false;
                    this.journeyData = null;
                },
                
                identifyLead(session) {
                    console.log('Identify lead for session:', session.session_id);
                    // TODO: Open modal to identify anonymous lead
                },
                
                sendProperty(session) {
                    console.log('Send property to:', session.lead_email);
                    // TODO: Open modal to send property recommendation
                },
                
                getStatusIcon(category) {
                    const icons = {
                        'hot': 'ðŸ”´',
                        'warm': 'ðŸŸ¡',
                        'cold': 'ðŸ”µ'
                    };
                    return icons[category] || 'ðŸ”µ';
                },
                
                getCategoryLabel(category) {
                    const labels = {
                        'hot': 'Hot',
                        'warm': 'Warm',
                        'cold': 'Cold'
                    };
                    return labels[category] || 'Cold';
                },
                
                getLocationString(location) {
                    if (!location) return '';
                    const parts = [];
                    if (location.city) parts.push(location.city);
                    if (location.state) parts.push(location.state);
                    return parts.join(', ');
                },
                
                formatDuration(seconds) {
                    if (seconds < 60) return `${seconds}s`;
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    return `${minutes}m ${remainingSeconds}s`;
                },
                
                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                },
                
                formatEventType(eventType) {
                    const types = {
                        'viewed': 'Viewed Property',
                        'saved': 'Saved Property',
                        'inquired': 'Sent Inquiry',
                        'applied': 'Submitted Application',
                        'searched': 'Searched Properties',
                        'session_start': 'Started Session'
                    };
                    return types[eventType] || eventType;
                },
                
                destroy() {
                    if (this.updateInterval) {
                        clearInterval(this.updateInterval);
                    }
                }
            };
        }
    </script>
    
    <!-- Session Journey Modal -->
    <template x-if="showJourneyModal" x-data="{ show: showJourneyModal }">
        <div class="session-journey-modal" @click.self="closeJourneyModal()" x-show="show" x-transition>
            <div class="session-journey-content">
                <div class="session-journey-header">
                    <h3 class="session-journey-title">Session Journey</h3>
                    <button class="session-journey-close" @click="closeJourneyModal()">&times;</button>
                </div>
                <div class="session-journey-body">
                    <div x-show="journeyData">
                        <div style="margin-bottom: 2rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                                <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.5rem;">Duration</div>
                                    <div style="font-size: 1.25rem; font-weight: 600;" x-text="journeyData ? Math.floor(journeyData.duration / 60) + 'm ' + (journeyData.duration % 60) + 's' : ''"></div>
                                </div>
                                <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.5rem;">Page Views</div>
                                    <div style="font-size: 1.25rem; font-weight: 600;" x-text="journeyData ? journeyData.page_views : ''"></div>
                                </div>
                                <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.5rem;">Total Events</div>
                                    <div style="font-size: 1.25rem; font-weight: 600;" x-text="journeyData ? journeyData.total_events : ''"></div>
                                </div>
                            </div>
                            
                            <h4 style="font-family: var(--font-family-primary); font-size: 1.25rem; margin-bottom: 1.5rem; color: var(--navy-primary);">Activity Timeline</h4>
                            <div class="session-timeline">
                                <template x-for="event in journeyData?.timeline || []" :key="event.timestamp">
                                    <div class="timeline-item">
                                        <div class="timeline-time" x-text="formatTime(event.timestamp)"></div>
                                        <div class="timeline-content">
                                            <div class="timeline-event-type" x-text="formatEventType(event.event_type)"></div>
                                            <div x-show="event.property" class="timeline-property">
                                                <div class="timeline-property-info">
                                                    <div class="timeline-property-address" x-text="event.property?.address"></div>
                                                    <div class="timeline-property-price" x-text="event.property ? '$' + event.property.price.toLocaleString() : ''"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
</body>
</html>
