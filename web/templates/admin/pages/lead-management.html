{% extends "layouts/admin-base.html" %}

{% block layout_data %}

{% endblock %}

{% block content %}
<div class="section">
    <div class="stats-grid stats-grid-4">
        <div class="stat-card">
            <div class="stat-value" x-text="stats.hot">0</div>
            <div class="stat-label">Hot Leads</div>
            <span class="score-badge hot">Score ≥70</span>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="stats.warm">0</div>
            <div class="stat-label">Warm Leads</div>
            <span class="score-badge warm">Score 40-69</span>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="stats.cold">0</div>
            <div class="stat-label">Cold Leads</div>
            <span class="score-badge cold">Score <40</span>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="stats.total">0</div>
            <div class="stat-label">Total Leads</div>
        </div>
    </div>
</div>

<div class="bulk-actions-bar" x-show="selectedLeads.length > 0" x-transition style="display: none;">
    <span class="selected-count" x-text="selectedLeads.length + ' selected'"></span>
    <div class="bulk-actions">
        <button class="btn btn-sm" @click="showBulkEmailModal()">Send Email</button>
        <button class="btn btn-sm" @click="showBulkAssignModal()">Assign to Agent</button>
        <button class="btn btn-sm" @click="showBulkStatusModal()">Update Status</button>
        <button class="btn btn-sm" @click="showBulkTagModal()">Add Tag</button>
        <button class="btn btn-sm btn-danger" @click="bulkArchive()">Archive</button>
    </div>
    <button class="btn btn-text" @click="clearSelection()">Clear Selection</button>
</div>

<div class="section">
    <div class="filters-bar">
        <div class="flex align-center gap-2">
            <input type="checkbox" class="select-all-checkbox" 
                   :checked="allSelected" 
                   @change="toggleAll()"
                   :indeterminate.prop="selectedLeads.length > 0 && !allSelected">
            <label class="text-sm text-gray-600">Select All</label>
        </div>
        
        <input type="search" class="search-input" placeholder="Search leads by name, email, or phone..." x-model="searchQuery">
        
        <select class="filter-select" x-model="filterSegment" @change="applyFilters()">
            <option value="all">All Leads</option>
            <option value="hot">Hot (≥70)</option>
            <option value="warm">Warm (40-69)</option>
            <option value="cold">Cold (<40)</option>
        </select>
        
        <select class="filter-select" x-model="filterTime" @change="applyFilters()">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
        </select>
        
        <a href="/admin/leads/add" class="btn btn-primary">
            + Add Lead
        </a>
    </div>
</div>

<div class="section">
    <div class="section-label admin-section-label">
      <span class="section-label-line"></span>
      <span class="section-label-text">All Leads</span>
      <span class="section-label-line"></span>
    </div>
    
    <div x-show="loading" class="text-center p-12">
        <div class="loading-spinner mx-auto"></div>
        <p class="text-gray-500 mt-4">Loading leads...</p>
    </div>
    
    <div x-show="!loading" class="leads-grid">
        <template x-for="lead in filteredLeads" :key="lead.id">
            <div class="lead-card" :class="getScoreClass(lead.behavioral_score)">
                <div class="lead-score-indicator" :class="getScoreClass(lead.behavioral_score)"></div>
                <input type="checkbox" class="lead-checkbox" :checked="selectedLeads.includes(lead.id)" @change="toggleLead(lead.id)">
                
                <div class="flex justify-between align-start mb-3">
                    <div>
                        <div class="lead-name" x-text="lead.name"></div>
                        <div class="lead-contact" x-text="lead.email"></div>
                        <div class="lead-contact" x-text="lead.phone || 'No phone'"></div>
                    </div>
                    <div class="lead-score-badge" :class="getScoreClass(lead.behavioral_score)">
                        <span class="score-value" x-text="Math.round(lead.behavioral_score || 0)"></span>
                        <span class="score-label" x-text="getScoreLabel(lead.behavioral_score)"></span>
                    </div>
                </div>
                
                <div class="pt-3 border-t border-gray-100">
                    <div class="ai-suggestion hot-lead" x-show="lead.behavioral_score >= 70">
                        <svg width="14" height="14" class="inline mr-1" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.66 11.2c-.23-.3-.51-.56-.77-.82-.67-.6-1.43-1.03-2.07-1.66C13.33 7.26 13 4.85 13.95 3c-.95.23-1.78.75-2.49 1.32-2.59 2.08-3.61 5.75-2.39 8.9.04.1.08.2.08.33 0 .22-.15.42-.35.5-.23.1-.47.04-.66-.12a.58.58 0 01-.14-.17c-1.13-1.43-1.31-3.48-.55-5.12C5.78 10 4.87 12.3 5 14.47c.06.5.12 1 .29 1.5.14.6.41 1.2.71 1.73 1.08 1.73 2.95 2.97 4.96 3.22 2.14.27 4.43-.12 6.07-1.6 1.83-1.66 2.47-4.32 1.53-6.6l-.13-.26c-.21-.46-.77-1.26-.77-1.26m-3.16 6.3c-.28.24-.74.5-1.1.6-1.12.4-2.24-.16-2.9-.82 1.19-.28 1.9-1.16 2.11-2.05.17-.8-.15-1.46-.28-2.23-.12-.74-.1-1.37.17-2.06.19.38.39.76.63 1.06.77 1 1.98 1.44 2.24 2.8.04.14.06.28.06.43.03.82-.33 1.72-.93 2.27z"></path>
                        </svg>
                        <strong>High Priority:</strong> Contact within 24 hours
                    </div>
                    <div class="ai-suggestion warm-lead" x-show="lead.behavioral_score >= 40 && lead.behavioral_score < 70">
                        <svg width="14" height="14" class="inline mr-1" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                        </svg>
                        <strong>Good Potential:</strong> Follow up this week
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="btn btn-primary flex-1 text-sm" @click="viewLeadDetails(lead.id)">
                            View Details
                        </button>
                        <button class="btn btn-secondary flex-1 text-sm" @click="contactLead(lead)">
                            Contact
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <div x-show="filteredLeads.length === 0 && !loading" class="text-center p-12" style="grid-column: 1 / -1;">
            <svg width="48" height="48" class="mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"></path>
            </svg>
            <div class="text-lg font-semibold text-gray-700 mb-2">No leads yet</div>
            <div class="text-sm text-gray-500">Your leads will appear here as they engage with your properties</div>
        </div>
    </div>
</div>

<div class="bulk-modal-overlay" x-show="showEmailModal" @click="closeEmailModal()" x-transition style="display: none;">
    <div class="bulk-modal" @click.stop>
        <h3>Send Email to <span x-text="selectedLeads.length"></span> Leads</h3>
        <div class="form-group">
            <label>Template</label>
            <select x-model="emailTemplate" @change="loadEmailTemplate()" class="form-input">
                <option value="">Custom Message</option>
                <option value="follow_up">Follow Up</option>
                <option value="new_listing">New Listing Alert</option>
                <option value="price_drop">Price Reduction</option>
            </select>
        </div>
        <div class="form-group">
            <label>Subject</label>
            <input type="text" x-model="emailSubject" class="form-input">
        </div>
        <div class="form-group">
            <label>Message</label>
            <textarea x-model="emailBody" rows="6" class="form-input"></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" @click="closeEmailModal()">Cancel</button>
            <button class="btn btn-primary" @click="sendBulkEmail()">Send to <span x-text="selectedLeads.length"></span> Leads</button>
        </div>
    </div>
</div>

<div class="bulk-modal-overlay" x-show="showAssignModal" @click="closeAssignModal()" x-transition style="display: none;">
    <div class="bulk-modal" @click.stop>
        <h3>Assign <span x-text="selectedLeads.length"></span> Leads to Agent</h3>
        <div class="form-group">
            <label>Select Agent</label>
            <select x-model="selectedAgent" class="form-input">
                <option value="">Choose an agent...</option>
                <option value="agent1">Agent 1</option>
                <option value="agent2">Agent 2</option>
                <option value="agent3">Agent 3</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" @click="closeAssignModal()">Cancel</button>
            <button class="btn btn-primary" @click="bulkAssign()">Assign Leads</button>
        </div>
    </div>
</div>

<div class="bulk-modal-overlay" x-show="showStatusModal" @click="closeStatusModal()" x-transition style="display: none;">
    <div class="bulk-modal" @click.stop>
        <h3>Update Status for <span x-text="selectedLeads.length"></span> Leads</h3>
        <div class="form-group">
            <label>New Status</label>
            <select x-model="selectedStatus" class="form-input">
                <option value="">Choose status...</option>
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="qualified">Qualified</option>
                <option value="negotiating">Negotiating</option>
                <option value="closed">Closed</option>
                <option value="lost">Lost</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" @click="closeStatusModal()">Cancel</button>
            <button class="btn btn-primary" @click="bulkUpdateStatus()">Update Status</button>
        </div>
    </div>
</div>

<div class="bulk-modal-overlay" x-show="showTagModal" @click="closeTagModal()" x-transition style="display: none;">
    <div class="bulk-modal" @click.stop>
        <h3>Add Tags to <span x-text="selectedLeads.length"></span> Leads</h3>
        <div class="form-group">
            <label>Tags (comma-separated)</label>
            <input type="text" x-model="newTags" placeholder="e.g., VIP, Houston, Buyer" class="form-input">
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" @click="closeTagModal()">Cancel</button>
            <button class="btn btn-primary" @click="bulkAddTags()">Add Tags</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/lead-management.js"></script>
{% endblock %}
