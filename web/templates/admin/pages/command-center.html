{% extends "layouts/admin-base.html" %}

{% block layout_data %}

{% endblock %}

{% block content %}
<div class="section">
    <div class="section-label admin-section-label">
      <span class="section-label-line"></span>
      <span class="section-label-text">AI Command Center</span>
      <span class="section-label-line"></span>
    </div>
    <p class="text-gray-500 mb-6">AI-powered action items and recommendations</p>
    
    <div x-show="loading" class="text-center p-12">
        <div class="loading-spinner mx-auto"></div>
        <p class="text-gray-500 mt-4">Loading action items...</p>
    </div>
    
    <div x-show="!loading && items.length === 0" class="empty-state">
        <svg width="64" height="64" class="mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div class="empty-state-title">All Clear!</div>
        <div class="empty-state-message">No action items at this time</div>
    </div>
    
    <div x-show="!loading && items.length > 0" class="d-grid gap-4">
        <template x-for="item in items" :key="item.id">
            <div class="card p-4">
                <div class="flex justify-between align-start mb-3">
                    <div class="flex-1">
                        <div class="flex align-center gap-2 mb-2">
                            <span class="badge" :class="'badge-' + item.priority" x-text="item.type"></span>
                            <span class="text-xs text-gray-500" x-text="formatTimeAgo(item.created_at)"></span>
                        </div>
                        <h4 class="text-lg font-semibold text-navy-primary mb-2" x-text="item.title"></h4>
                        <p class="text-sm text-gray-600 mb-3" x-text="item.subtitle"></p>
                        <div class="p-3 bg-gray-50 rounded-md text-sm text-gray-700 mb-3" x-show="item.suggestion" x-text="item.suggestion"></div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <template x-for="action in item.actions" :key="action.id">
                        <button class="btn btn-sm btn-primary" @click="executeAction(item.id, action.id)" x-text="action.label"></button>
                    </template>
                    <button class="btn btn-sm btn-secondary" @click="dismissItem(item.id)">Dismiss</button>
                </div>
            </div>
        </template>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function commandCenter() {
        return {
            loading: true,
            items: [],
            
            async init() {
                await this.fetchItems();
            },
            
            async fetchItems() {
                try {
                    const response = await fetch('/api/command-center/items');
                    if (response.ok) {
                        this.items = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch items:', error);
                } finally {
                    this.loading = false;
                }
            },
            
            async executeAction(itemId, actionId) {
                try {
                    const response = await fetch('/api/command-center/act', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ item_id: itemId, action_id: actionId })
                    });
                    
                    if (response.ok) {
                        await this.fetchItems();
                    }
                } catch (error) {
                    console.error('Failed to execute action:', error);
                }
            },
            
            async dismissItem(itemId) {
                try {
                    const response = await fetch('/api/command-center/dismiss', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ item_id: itemId })
                    });
                    
                    if (response.ok) {
                        await this.fetchItems();
                    }
                } catch (error) {
                    console.error('Failed to dismiss item:', error);
                }
            },
            
            formatTimeAgo(timestamp) {
                const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
                if (seconds < 60) return 'just now';
                if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
                if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
                return Math.floor(seconds / 86400) + 'd ago';
            }
        };
    }
</script>
{% endblock %}
