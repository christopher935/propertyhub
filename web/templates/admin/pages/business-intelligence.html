{{define "business-intelligence"}}
{{template "admin-base" .}}

{{define "head"}}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{{end}}

{{define "layout-data"}}x-data="businessIntelligenceData()" x-init="init()"{{end}}

{{define "content"}}
<div class="section">
    <div class="flex justify-between align-center mb-6">
        <div>
            <h2 class="text-2xl font-semibold text-navy-primary">Business Intelligence</h2>
            <p class="text-gray-500">Comprehensive analytics and insights</p>
        </div>
        <select class="filter-select" x-model="timeRange" @change="refreshData()">
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
            <option value="90d">Last 90 Days</option>
            <option value="1y">Last Year</option>
        </select>
    </div>
    
    <div class="stats-grid-4 mb-6">
        <div class="stat-card">
            <div class="stat-card-label">Total Revenue</div>
            <div class="stat-card-value" x-text="formatCurrency(metrics.total_revenue)">$0</div>
            <div class="stat-card-change positive" x-text="'+' + metrics.revenue_change + '%'"></div>
        </div>
        <div class="stat-card">
            <div class="stat-card-label">Active Deals</div>
            <div class="stat-card-value" x-text="metrics.active_deals">0</div>
            <div class="stat-card-subtitle">In pipeline</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-label">Conversion Rate</div>
            <div class="stat-card-value" x-text="metrics.conversion_rate + '%'">0%</div>
            <div class="stat-card-change" :class="metrics.conversion_trend > 0 ? 'positive' : 'negative'" x-text="metrics.conversion_trend + '%'"></div>
        </div>
        <div class="stat-card">
            <div class="stat-card-label">Avg Deal Size</div>
            <div class="stat-card-value" x-text="formatCurrency(metrics.avg_deal_size)">$0</div>
        </div>
    </div>
    
    <div class="charts-grid charts-grid-2 mb-6">
        <div class="chart-card">
            <div class="chart-card-header">
                <h3 class="chart-card-title">Revenue Trend</h3>
                <p class="chart-card-subtitle">Monthly performance</p>
            </div>
            <div class="chart-card-body">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-card-header">
                <h3 class="chart-card-title">Lead Sources</h3>
                <p class="chart-card-subtitle">Distribution</p>
            </div>
            <div class="chart-card-body">
                <canvas id="leadSourceChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="charts-grid charts-grid-2 mb-6">
        <div class="chart-card">
            <div class="chart-card-header">
                <h3 class="chart-card-title">Conversion Funnel</h3>
                <p class="chart-card-subtitle">Lead to close</p>
            </div>
            <div class="chart-card-body">
                <canvas id="funnelChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-card-header">
                <h3 class="chart-card-title">Property Performance</h3>
                <p class="chart-card-subtitle">Views and inquiries</p>
            </div>
            <div class="chart-card-body">
                <canvas id="propertyPerformanceChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="card p-6">
        <h3 class="text-lg font-semibold text-navy-primary mb-4">Top Performing Properties</h3>
        <div x-show="loading" class="text-center p-6">
            <div class="loading-spinner mx-auto"></div>
        </div>
        
        <div x-show="!loading">
            <table class="performance-table">
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Views</th>
                        <th>Inquiries</th>
                        <th>Showings</th>
                        <th>Conversion</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="property in topProperties" :key="property.id">
                        <tr>
                            <td class="font-semibold text-navy-primary" x-text="property.address"></td>
                            <td x-text="property.views"></td>
                            <td x-text="property.inquiries"></td>
                            <td x-text="property.showings"></td>
                            <td x-text="property.conversion_rate + '%'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
    function businessIntelligenceData() {
        return {
            loading: true,
            timeRange: '30d',
            metrics: {
                total_revenue: 0,
                revenue_change: 0,
                active_deals: 0,
                conversion_rate: 0,
                conversion_trend: 0,
                avg_deal_size: 0
            },
            topProperties: [],
            
            async init() {
                await this.refreshData();
                this.initCharts();
            },
            
            async refreshData() {
                this.loading = true;
                try {
                    const response = await fetch(`/api/v1/bi/metrics?range=${this.timeRange}`);
                    if (response.ok) {
                        const data = await response.json();
                        this.metrics = data.metrics;
                        this.topProperties = data.top_properties || [];
                    }
                } catch (error) {
                    console.error('Failed to fetch metrics:', error);
                } finally {
                    this.loading = false;
                }
            },
            
            initCharts() {
                const revenueCtx = document.getElementById('revenueChart');
                if (revenueCtx) {
                    new Chart(revenueCtx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Revenue',
                                data: [12000, 15000, 13000, 17000, 16000, 19000],
                                borderColor: 'rgb(196, 169, 98)',
                                tension: 0.4
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                
                const leadSourceCtx = document.getElementById('leadSourceChart');
                if (leadSourceCtx) {
                    new Chart(leadSourceCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Website', 'Referral', 'Social', 'Direct'],
                            datasets: [{
                                data: [45, 25, 20, 10],
                                backgroundColor: ['#1b3559', '#c4a962', '#10b981', '#3b82f6']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                
                const funnelCtx = document.getElementById('funnelChart');
                if (funnelCtx) {
                    new Chart(funnelCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Leads', 'Qualified', 'Showing', 'Application', 'Closed'],
                            datasets: [{
                                label: 'Count',
                                data: [100, 75, 50, 30, 15],
                                backgroundColor: '#1b3559'
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                
                const propertyPerfCtx = document.getElementById('propertyPerformanceChart');
                if (propertyPerfCtx) {
                    new Chart(propertyPerfCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Property A', 'Property B', 'Property C'],
                            datasets: [{
                                label: 'Views',
                                data: [450, 380, 320],
                                backgroundColor: '#c4a962'
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            },
            
            formatCurrency(value) {
                return '$' + (value || 0).toLocaleString();
            }
        };
    }
</script>
{{end}}

{{end}}
