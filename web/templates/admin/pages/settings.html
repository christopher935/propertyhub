{{template "admin-base" .}}

{{define "additional-css"}}
<link rel="stylesheet" href="/static/css/settings-page.css">
<link rel="stylesheet" href="/static/css/password-strength.css">
{{end}}

{{define "content"}}
<div id="alert-container"></div>

<div class="settings-tabs">
    <button class="settings-tab active" data-tab="profile">Profile</button>
    <button class="settings-tab" data-tab="security">Security</button>
    <button class="settings-tab" data-tab="preferences">Preferences</button>
</div>

<div id="profile-tab" class="tab-content active">
    <div class="settings-card">
        <div class="settings-card-header">
            <div class="section-label admin-section-label">
              <span class="section-label-line"></span>
              <span class="section-label-text">Profile Photo</span>
              <span class="section-label-line"></span>
            </div>
            <p class="settings-card-subtitle">Upload a profile picture for your account</p>
        </div>
        <div class="settings-card-body">
            <div class="profile-photo-section">
                <div id="photo-container">
                    <div class="profile-photo-placeholder">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
                <div class="profile-photo-actions">
                    <input type="file" id="photo-upload" accept="image/jpeg,image/png" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('photo-upload').click()">
                        Upload Photo
                    </button>
                    <p class="form-help">JPG or PNG, max 5MB</p>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-card">
        <div class="settings-card-header">
            <div class="section-label admin-section-label">
              <span class="section-label-line"></span>
              <span class="section-label-text">Personal Information</span>
              <span class="section-label-line"></span>
            </div>
            <p class="settings-card-subtitle">Update your personal details</p>
        </div>
        <div class="settings-card-body">
            <form id="profile-form">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <div class="form-row">
                    <div class="form-group">
                        <label for="first-name">First Name</label>
                        <input type="text" id="first-name" name="first_name">
                    </div>
                    <div class="form-group">
                        <label for="last-name">Last Name</label>
                        <input type="text" id="last-name" name="last_name">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" disabled>
                        <p class="form-help">Email cannot be changed</p>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="company">Company</label>
                        <input type="text" id="company" name="company">
                    </div>
                    <div class="form-group">
                        <label for="department">Department</label>
                        <input type="text" id="department" name="department">
                    </div>
                </div>

                <div class="form-group">
                    <label for="job-title">Job Title</label>
                    <input type="text" id="job-title" name="job_title">
                </div>

                <div class="form-group">
                    <label for="bio">Bio</label>
                    <textarea id="bio" name="bio"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>
</div>

<div id="security-tab" class="tab-content">
    <div class="settings-card">
        <div class="settings-card-header">
            <div class="section-label admin-section-label">
              <span class="section-label-line"></span>
              <span class="section-label-text">Two-Factor Authentication</span>
              <span class="section-label-line"></span>
            </div>
            <p class="settings-card-subtitle">Add an extra layer of security to your account</p>
        </div>
        <div class="settings-card-body" x-data="mfaStatusData()">
            <div x-show="loading" class="d-flex justify-center p-6">
                <div class="loading"></div>
            </div>
            
            <div x-show="!loading">
                <div class="mfa-status-section" :class="mfaEnabled ? 'enabled' : 'disabled'">
                    <svg class="mfa-status-icon" width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" :d="mfaEnabled ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' : 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'"></path>
                    </svg>
                    <div class="mfa-status-content">
                        <h4 x-text="mfaEnabled ? 'Two-Factor Authentication Enabled' : 'Two-Factor Authentication Disabled'"></h4>
                        <p x-show="mfaEnabled" x-text="'Backup codes remaining: ' + backupCodesRemaining"></p>
                        <p x-show="!mfaEnabled">Protect your account with an additional layer of security</p>
                    </div>
                    <div class="mfa-status-actions">
                        <a x-show="!mfaEnabled" href="/admin/mfa-setup" class="btn btn-primary">Enable 2FA</a>
                        <a x-show="mfaEnabled" href="/admin/mfa-manage" class="btn btn-outline">Manage</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-card">
        <div class="settings-card-header">
            <div class="section-label admin-section-label">
              <span class="section-label-line"></span>
              <span class="section-label-text">Change Password</span>
              <span class="section-label-line"></span>
            </div>
            <p class="settings-card-subtitle">Update your password to keep your account secure</p>
        </div>
        <div class="settings-card-body">
            <form id="password-form">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" name="current_password" required>
                </div>

                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" name="new_password" required>
                    <div id="password-strength"></div>
                    <div id="password-requirements" class="password-requirements">
                        <div class="requirement" id="req-length">
                            <span class="requirement-icon">○</span>
                            <span>At least 12 characters</span>
                        </div>
                        <div class="requirement" id="req-uppercase">
                            <span class="requirement-icon">○</span>
                            <span>One uppercase letter</span>
                        </div>
                        <div class="requirement" id="req-lowercase">
                            <span class="requirement-icon">○</span>
                            <span>One lowercase letter</span>
                        </div>
                        <div class="requirement" id="req-number">
                            <span class="requirement-icon">○</span>
                            <span>One number</span>
                        </div>
                        <div class="requirement" id="req-special">
                            <span class="requirement-icon">○</span>
                            <span>One special character</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input type="password" id="confirm-password" name="confirm_password" required>
                </div>

                <button type="submit" class="btn btn-primary">Change Password</button>
            </form>
        </div>
    </div>
</div>

<div id="preferences-tab" class="tab-content">
    <div class="settings-card">
        <div class="settings-card-header">
            <div class="section-label admin-section-label">
              <span class="section-label-line"></span>
              <span class="section-label-text">Notifications</span>
              <span class="section-label-line"></span>
            </div>
            <p class="settings-card-subtitle">Manage your notification preferences</p>
        </div>
        <div class="settings-card-body">
            <form id="notifications-form">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="email_notifications" checked>
                        <span>Email Notifications</span>
                    </label>
                    <p class="form-help">Receive email updates about leads and bookings</p>
                </div>

                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="browser_notifications">
                        <span>Browser Notifications</span>
                    </label>
                    <p class="form-help">Get real-time notifications in your browser</p>
                </div>

                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="weekly_report" checked>
                        <span>Weekly Performance Report</span>
                    </label>
                    <p class="form-help">Receive a summary email every Friday</p>
                </div>

                <button type="submit" class="btn btn-primary">Save Preferences</button>
            </form>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script src="/static/js/password-strength.js"></script>
<script src="/static/js/mfa-prompt.js"></script>
<script>
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            this.classList.add('active');
            const tabId = this.dataset.tab + '-tab';
            document.getElementById(tabId).classList.add('active');
        });
    });

    document.getElementById('profile-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            const response = await fetch('/api/admin/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showAlert('Profile updated successfully', 'success');
            } else {
                showAlert('Failed to update profile', 'error');
            }
        } catch (error) {
            showAlert('An error occurred', 'error');
        }
    });

    document.getElementById('password-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            const response = await fetch('/api/admin/password', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showAlert('Password changed successfully', 'success');
                e.target.reset();
            } else {
                const result = await response.json();
                showAlert(result.error || 'Failed to change password', 'error');
            }
        } catch (error) {
            showAlert('An error occurred', 'error');
        }
    });

    document.getElementById('notifications-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            const response = await fetch('/api/admin/preferences', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showAlert('Preferences updated successfully', 'success');
            } else {
                showAlert('Failed to update preferences', 'error');
            }
        } catch (error) {
            showAlert('An error occurred', 'error');
        }
    });

    function showAlert(message, type) {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        container.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    function mfaStatusData() {
        return {
            loading: true,
            mfaEnabled: false,
            backupCodesRemaining: 0,
            
            async init() {
                try {
                    const response = await fetch('/api/admin/mfa/status');
                    if (response.ok) {
                        const data = await response.json();
                        this.mfaEnabled = data.enabled;
                        this.backupCodesRemaining = data.backup_codes_remaining || 0;
                    }
                } catch (error) {
                    console.error('Failed to fetch MFA status:', error);
                } finally {
                    this.loading = false;
                }
            }
        };
    }
</script>
{{end}}
