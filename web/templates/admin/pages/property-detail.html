{% extends "layouts/admin-base.html" %}

{% block layout_data %}x-data="propertyDetailData()" x-init="init()"{% endblock %}

{% block content %}
<div class="mb-2">
    <a href="/admin/properties" class="text-gray-500 text-sm">← Back to Properties</a>
</div>

<div x-show="loading" class="d-flex justify-center p-6">
    <div class="loading"></div>
</div>

<div x-show="!loading">
    <div class="card p-6 mb-6">
        <div class="flex justify-between align-start mb-6">
            <div class="flex-1">
                <div class="flex align-center gap-3 mb-3">
                    <h2 class="text-2xl font-semibold text-navy-primary m-0" x-text="property.address"></h2>
                    <span class="status-badge" :class="'status-' + property.status" x-text="property.status"></span>
                </div>
                <p class="text-gray-500 mb-2" x-text="property.city + ', ' + property.state + ' ' + property.zip"></p>
                <div class="flex gap-4 text-gray-600">
                    <span x-text="property.bedrooms + ' beds'"></span>
                    <span>•</span>
                    <span x-text="property.bathrooms + ' baths'"></span>
                    <span>•</span>
                    <span x-text="property.square_feet + ' sqft'"></span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-3xl font-bold text-gold-primary" x-text="'$' + property.price.toLocaleString()"></div>
                <div class="text-gray-500 text-sm">Listed Price</div>
            </div>
        </div>
        
        <div class="flex gap-3">
            <a :href="'/admin/property-edit/' + property.id" class="btn btn-primary">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit Property
            </a>
            <button class="btn btn-secondary" @click="archiveProperty">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                </svg>
                Archive
            </button>
        </div>
    </div>
    
    <div class="d-grid gap-6" style="grid-template-columns: 2fr 1fr;">
        <div>
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-semibold text-navy-primary mb-4">Property Photos</h3>
                <div class="d-grid gap-3" style="grid-template-columns: repeat(3, 1fr);">
                    <template x-for="(photo, index) in property.photos" :key="index">
                        <img :src="photo" :alt="'Property photo ' + (index + 1)" class="w-full rounded-md" style="height: 200px; object-fit: cover;">
                    </template>
                    <div x-show="property.photos.length === 0" class="text-center p-8 text-gray-400" style="grid-column: 1/-1;">
                        No photos uploaded yet
                    </div>
                </div>
            </div>
            
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-semibold text-navy-primary mb-4">Description</h3>
                <p class="text-gray-600" style="line-height: 1.6;" x-text="property.description"></p>
            </div>
            
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-navy-primary mb-4">Showing History</h3>
                <div>
                    <template x-for="showing in showings" :key="showing.id">
                        <div class="p-3 border border-gray-200 rounded-md mb-3">
                            <div class="flex justify-between align-center">
                                <div>
                                    <div class="font-semibold text-navy-primary" x-text="showing.lead_name"></div>
                                    <div class="text-sm text-gray-500" x-text="new Date(showing.scheduled_at).toLocaleString()"></div>
                                </div>
                                <span class="status-badge" :class="'status-' + showing.status" x-text="showing.status"></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="showings.length === 0" class="text-center p-6 text-gray-400">
                        No showings scheduled
                    </div>
                </div>
            </div>
        </div>
        
        <div>
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-semibold text-navy-primary mb-4">Property Details</h3>
                <div class="d-grid gap-3">
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Type</div>
                        <div class="font-semibold text-navy-primary" x-text="property.property_type"></div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Listing Type</div>
                        <div class="font-semibold text-navy-primary" x-text="property.listing_type"></div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Year Built</div>
                        <div class="font-semibold text-navy-primary" x-text="property.year_built"></div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Lot Size</div>
                        <div class="font-semibold text-navy-primary" x-text="property.lot_size"></div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Listed Date</div>
                        <div class="font-semibold text-navy-primary" x-text="new Date(property.created_at).toLocaleDateString()"></div>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-navy-primary mb-4">Performance</h3>
                <div class="d-grid gap-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-navy-primary" x-text="stats.views"></div>
                        <div class="text-sm text-gray-500">Total Views</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-navy-primary" x-text="stats.inquiries"></div>
                        <div class="text-sm text-gray-500">Inquiries</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-navy-primary" x-text="stats.showings"></div>
                        <div class="text-sm text-gray-500">Showings</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function propertyDetailData() {
        return {
            loading: true,
            property: {
                id: null,
                address: '',
                city: '',
                state: '',
                zip: '',
                price: 0,
                bedrooms: 0,
                bathrooms: 0,
                square_feet: 0,
                property_type: '',
                listing_type: '',
                status: '',
                year_built: '',
                lot_size: '',
                description: '',
                photos: [],
                created_at: ''
            },
            showings: [],
            stats: {
                views: 0,
                inquiries: 0,
                showings: 0
            },
            
            async init() {
                const propertyId = window.location.pathname.split('/').pop();
                await Promise.all([
                    this.fetchProperty(propertyId),
                    this.fetchShowings(propertyId),
                    this.fetchStats(propertyId)
                ]);
            },
            
            async fetchProperty(id) {
                try {
                    const response = await fetch(`/api/properties/${id}`);
                    if (response.ok) {
                        this.property = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch property:', error);
                } finally {
                    this.loading = false;
                }
            },
            
            async fetchShowings(id) {
                try {
                    const response = await fetch(`/api/properties/${id}/showings`);
                    if (response.ok) {
                        this.showings = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch showings:', error);
                }
            },
            
            async fetchStats(id) {
                try {
                    const response = await fetch(`/api/properties/${id}/stats`);
                    if (response.ok) {
                        this.stats = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch stats:', error);
                }
            },
            
            archiveProperty() {
                if (confirm('Are you sure you want to archive this property?')) {
                    fetch(`/api/properties/${this.property.id}`, {
                        method: 'DELETE'
                    }).then(() => {
                        window.location.href = '/admin/properties';
                    });
                }
            }
        };
    }
</script>
{% endblock %}
