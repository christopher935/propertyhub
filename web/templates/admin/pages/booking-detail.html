{% extends "layouts/admin-base.html" %}

{% block layout_data %}x-data="bookingDetailData()" x-init="init()"{% endblock %}

{% block content %}
<div class="mb-2">
    <a href="/admin/bookings" class="text-gray-500 text-sm">← Back to Bookings</a>
</div>

<div x-show="loading" class="d-flex justify-center p-6">
    <div class="loading"></div>
</div>

<div x-show="!loading">
    <div class="card p-6 mb-6">
        <div class="flex justify-between align-start mb-6">
            <div class="flex-1">
                <div class="flex align-center gap-3 mb-3">
                    <h2 class="text-2xl font-semibold text-navy-primary m-0">
                        Showing #<span x-text="booking.id"></span>
                    </h2>
                    <span class="status-badge" :class="'status-' + booking.status" x-text="booking.status"></span>
                </div>
                <p class="text-gray-500 mb-2">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="inline align-middle mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span x-text="new Date(booking.scheduled_at).toLocaleString()"></span>
                </p>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button class="btn btn-primary" @click="showRescheduleModal = true" x-show="booking.status === 'confirmed'">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Reschedule
            </button>
            <button class="btn btn-secondary" @click="cancelBooking" x-show="booking.status === 'confirmed'">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                Cancel Showing
            </button>
            <button class="btn btn-secondary" @click="markCompleted" x-show="booking.status === 'confirmed'">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Mark Completed
            </button>
        </div>
    </div>
    
    <div class="d-grid gap-6" style="grid-template-columns: 2fr 1fr;">
        <div>
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-semibold text-navy-primary mb-4">Property Details</h3>
                <div class="flex gap-4 align-start">
                    <div x-show="booking.property_photo" class="rounded-md overflow-hidden bg-gray-100" style="width: 120px; height: 120px;">
                        <img :src="booking.property_photo" alt="Property" class="w-full h-full" style="object-fit: cover;">
                    </div>
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold text-navy-primary mb-2" x-text="booking.property_address"></h4>
                        <p class="text-gray-600 mb-3" x-text="booking.property_city + ', ' + booking.property_state"></p>
                        <a :href="'/admin/property-detail/' + booking.property_id" class="btn btn-secondary text-sm">
                            View Property Details →
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-semibold text-navy-primary mb-4">Lead Information</h3>
                <div class="d-grid gap-3">
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Name</div>
                        <div class="font-semibold text-navy-primary" x-text="booking.lead_name"></div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Email</div>
                        <a :href="'mailto:' + booking.lead_email" class="text-gold-primary" x-text="booking.lead_email"></a>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Phone</div>
                        <a :href="'tel:' + booking.lead_phone" class="text-gold-primary" x-text="booking.lead_phone"></a>
                    </div>
                    <div>
                        <a :href="'/admin/lead-detail/' + booking.lead_id" class="btn btn-secondary text-sm w-full">
                            View Lead Profile →
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-navy-primary mb-4">Notes</h3>
                <div class="mb-4">
                    <template x-for="note in notes" :key="note.id">
                        <div class="p-3 bg-gray-50 rounded-md mb-3">
                            <div class="flex justify-between mb-2">
                                <span class="font-semibold text-navy-primary" x-text="note.created_by"></span>
                                <span class="text-xs text-gray-500" x-text="new Date(note.created_at).toLocaleString()"></span>
                            </div>
                            <p class="text-gray-700" x-text="note.content"></p>
                        </div>
                    </template>
                    <div x-show="notes.length === 0" class="text-center p-4 text-gray-400">
                        No notes yet
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Add Note</label>
                    <textarea x-model="newNote" rows="3" placeholder="Add a note about this showing..." class="form-input mb-3" style="resize: vertical;"></textarea>
                    <button @click="addNote" class="btn btn-primary w-full" :disabled="!newNote.trim()">
                        Add Note
                    </button>
                </div>
            </div>
        </div>
        
        <div>
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-navy-primary mb-4">Booking Timeline</h3>
                <div class="d-grid gap-4">
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Requested</div>
                        <div class="font-semibold text-navy-primary" x-text="new Date(booking.created_at).toLocaleDateString()"></div>
                    </div>
                    <div x-show="booking.confirmed_at">
                        <div class="text-xs text-gray-500 uppercase">Confirmed</div>
                        <div class="font-semibold text-navy-primary" x-text="new Date(booking.confirmed_at).toLocaleDateString()"></div>
                    </div>
                    <div x-show="booking.cancelled_at">
                        <div class="text-xs text-gray-500 uppercase">Cancelled</div>
                        <div class="font-semibold text-error" x-text="new Date(booking.cancelled_at).toLocaleDateString()"></div>
                    </div>
                    <div x-show="booking.completed_at">
                        <div class="text-xs text-gray-500 uppercase">Completed</div>
                        <div class="font-semibold text-success" x-text="new Date(booking.completed_at).toLocaleDateString()"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function bookingDetailData() {
        return {
            loading: true,
            bookingId: null,
            booking: {
                id: null,
                status: '',
                scheduled_at: '',
                property_id: null,
                property_address: '',
                property_city: '',
                property_state: '',
                property_photo: '',
                lead_id: null,
                lead_name: '',
                lead_email: '',
                lead_phone: '',
                created_at: '',
                confirmed_at: null,
                cancelled_at: null,
                completed_at: null
            },
            notes: [],
            newNote: '',
            showRescheduleModal: false,
            
            async init() {
                this.bookingId = window.location.pathname.split('/').pop();
                await Promise.all([
                    this.fetchBooking(),
                    this.fetchNotes()
                ]);
            },
            
            async fetchBooking() {
                try {
                    const response = await fetch(`/api/v1/bookings/${this.bookingId}`);
                    if (response.ok) {
                        this.booking = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch booking:', error);
                } finally {
                    this.loading = false;
                }
            },
            
            async fetchNotes() {
                try {
                    const response = await fetch(`/api/v1/bookings/${this.bookingId}/notes`);
                    if (response.ok) {
                        this.notes = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch notes:', error);
                }
            },
            
            async addNote() {
                if (!this.newNote.trim()) return;
                
                try {
                    const response = await fetch(`/api/v1/bookings/${this.bookingId}/notes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: this.newNote })
                    });
                    
                    if (response.ok) {
                        this.newNote = '';
                        await this.fetchNotes();
                    }
                } catch (error) {
                    console.error('Failed to add note:', error);
                }
            },
            
            async cancelBooking() {
                if (confirm('Are you sure you want to cancel this showing?')) {
                    try {
                        const response = await fetch(`/api/v1/bookings/${this.bookingId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'cancelled' })
                        });
                        
                        if (response.ok) {
                            await this.fetchBooking();
                        }
                    } catch (error) {
                        console.error('Failed to cancel booking:', error);
                    }
                }
            },
            
            async markCompleted() {
                try {
                    const response = await fetch(`/api/v1/bookings/${this.bookingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'completed' })
                    });
                    
                    if (response.ok) {
                        await this.fetchBooking();
                    }
                } catch (error) {
                    console.error('Failed to mark as completed:', error);
                }
            }
        };
    }
</script>
{% endblock %}
