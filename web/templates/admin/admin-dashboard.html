<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <title>Dashboard - PropertyHub</title>
    <link rel="stylesheet" href="/static/css/admin-design-tokens.css">
    <link rel="stylesheet" href="/static/css/admin-scout-utilities.css">
    <link rel="stylesheet" href="/static/css/admin-scout-layouts.css">
    <link rel="stylesheet" href="/static/css/scout-components-admin.css">
    <link rel="stylesheet" href="/static/css/dashboard-interactions.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }
        
        .heatmap-labels {
            display: grid;
            grid-template-rows: repeat(7, 1fr);
            gap: 2px;
            margin-right: 8px;
        }
        
        .heatmap-label {
            font-size: 11px;
            text-align: right;
            padding-right: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        .stat-card-mini {
            padding: 12px;
            min-height: auto;
        }
        
        .ai-narration {
            font-style: italic;
            color: var(--color-gray-600);
            font-size: 13px;
            margin-top: 8px;
            padding: 8px;
            background: var(--color-gray-50);
            border-left: 3px solid var(--color-secondary);
            border-radius: 4px;
        }
        
        .insight-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="admin-layout" x-data="dashboardData()" x-init="init()">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <a href="/admin/dashboard" class="sidebar-logo">
                    <div class="sidebar-logo-icon">PH</div>
                    <span>PropertyHub</span>
                </a>
            </div>
            
            <nav class="admin-sidebar-nav">
                <div class="nav-section expanded">
                    <a href="/admin/dashboard" class="nav-section-header active">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                        <span class="nav-section-title">Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-section" x-data="{ open: false }">
                    <button class="nav-section-header" @click="open = !open">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                        <span class="nav-section-title">Leads</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.total_leads || 0"></span>
                        <svg class="w-4 h-4 nav-section-toggle transition" :class="{ 'rotate-90': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <ul class="nav-section-items" x-show="open" x-collapse>
                        <li><a href="/admin/leads" class="nav-item">All Leads <span class="nav-item-badge" x-text="sidebarCounts.total_leads || 0"></span></a></li>
                        <li><a href="/admin/leads?segment=hot" class="nav-item">Hot Leads <span class="nav-item-badge" x-text="sidebarCounts.hot_leads || 0"></span></a></li>
                        <li><a href="/admin/leads?segment=warm" class="nav-item">Warm Leads <span class="nav-item-badge" x-text="sidebarCounts.warm_leads || 0"></span></a></li>
                        <li><a href="/admin/communication" class="nav-item">Communication Center</a></li>
                    </ul>
                </div>
                
                <div class="nav-section" x-data="{ open: false }">
                    <button class="nav-section-header" @click="open = !open">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></div>
                        <span class="nav-section-title">Properties</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.active_properties || 0"></span>
                        <svg class="w-4 h-4 nav-section-toggle transition" :class="{ 'rotate-90': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <ul class="nav-section-items" x-show="open" x-collapse>
                        <li><a href="/admin/properties" class="nav-item">All Properties</a></li>
                        <li><a href="/admin/properties?status=active" class="nav-item">Active Listings</a></li>
                        <li><a href="/admin/properties?status=pending_images" class="nav-item">Pending Images <span class="nav-item-badge" x-text="sidebarCounts.pending_images || 0"></span></a></li>
                        <li><a href="/admin/pre-listing" class="nav-item">Pre-Listing Pipeline</a></li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <a href="/admin/applications" class="nav-section-header">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                        <span class="nav-section-title">Applications</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.pending_applications || 0"></span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <a href="/admin/bookings" class="nav-section-header">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>
                        <span class="nav-section-title">Bookings</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.confirmed_bookings || 0"></span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <a href="/admin/closing-pipeline" class="nav-section-header">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg></div>
                        <span class="nav-section-title">Closing Pipeline</span>
                        <span class="nav-section-badge" x-text="sidebarCounts.closing_pipeline || 0"></span>
                    </a>
                </div>
                
                <div class="nav-section" x-data="{ open: false }">
                    <button class="nav-section-header" @click="open = !open">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></div>
                        <span class="nav-section-title">Intelligence</span>
                        <svg class="w-4 h-4 nav-section-toggle transition" :class="{ 'rotate-90': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <ul class="nav-section-items" x-show="open" x-collapse>
                        <li><a href="/admin/business-intelligence" class="nav-item">Business Intelligence</a></li>
                        <li><a href="/admin/behavioral-intelligence" class="nav-item">Behavioral Analytics</a></li>
                        <li><a href="/admin/market-intelligence" class="nav-item">Market Intelligence</a></li>
                    </ul>
                </div>
                
                <div class="nav-section" x-data="{ open: false }">
                    <button class="nav-section-header" @click="open = !open">
                        <div class="nav-section-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
                        <span class="nav-section-title">System</span>
                        <svg class="w-4 h-4 nav-section-toggle transition" :class="{ 'rotate-90': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <ul class="nav-section-items" x-show="open" x-collapse>
                        <li><a href="/admin/settings" class="nav-item">Settings</a></li>
                        <li><a href="/admin/rbac" class="nav-item">Roles & Permissions</a></li>
                        <li><a href="/admin/integrations/webhooks" class="nav-item">Integrations</a></li>
                        <li><a href="/admin/security" class="nav-item">Security Monitoring</a></li>
                    </ul>
                </div>
            </nav>
        </aside>
       <main class="admin-main">
            <header class="admin-header">
                <div class="admin-header-content">
                    <h1 class="admin-header-title">Dashboard</h1>
                    
                    <div class="admin-header-actions">
                        <div class="admin-search">
                            <input type="search" placeholder="Search leads, properties..." x-model="searchQuery" @input.debounce.300ms="performSearch">
                            <svg class="admin-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <div class="admin-user-menu">
                            <div class="admin-user-avatar" x-text="userProfile.initials"></div>
                            <div class="admin-user-info">
                                <div class="admin-user-name" x-text="userProfile.username"></div>
                                <div class="admin-user-role" x-text="userProfile.role"></div>
                            </div>
                        </div>
                        
                        <a href="/admin/logout" class="btn-logout">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </a>
                    </div>
                </div>
            </header>
            
            <div class="admin-content">
                <div class="dashboard-grid-4">
                    <div class="stat-card" x-data="statCard('active_users')">
                        <div class="stat-card-label">Active Users</div>
                        <div class="stat-card-value" x-text="Math.round(displayValue)"></div>
                        <span class="status-badge status-ok">Live</span>
                        <div class="stat-card-subtitle">Last 15 minutes</div>
                        <div class="ai-narration" x-show="displayValue > 5">
                            High traffic detected. Consider increasing server capacity.
                        </div>
                    </div>
                    
                    <div class="stat-card" x-data="statCard('unread_messages')">
                        <div class="stat-card-label">Unread Messages</div>
                        <div class="stat-card-value" x-text="Math.round(displayValue)"></div>
                        <div class="stat-card-subtitle">Inbox</div>
                        <div class="stat-actions">
                            <button class="btn btn-sm btn-primary" @click="window.location.href='/admin/communication'">
                                View Inbox
                            </button>
                        </div>
                    </div>
                    
                    <div class="stat-card" x-data="statCard('current_showings')">
                        <div class="stat-card-label">Current Showings</div>
                        <div class="stat-card-value" x-text="Math.round(displayValue)"></div>
                        <div class="stat-card-subtitle">Happening now</div>
                        <div class="stat-actions">
                            <button class="btn btn-sm btn-secondary" @click="window.location.href='/admin/bookings'">
                                View Calendar
                            </button>
                        </div>
                    </div>
                    
                    <div class="stat-card" x-data="statCard('hot_leads')">
                        <div class="stat-card-label">Hot Leads</div>
                        <div class="stat-card-value" x-text="Math.round(displayValue)"></div>
                        <div class="stat-card-subtitle">Score &gt; 70 - Contact within 1 hour</div>
                        <div class="stat-actions">
                            <button class="btn btn-sm btn-danger" @click="window.location.href='/admin/leads?segment=hot'">
                                View Hot Leads
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-between align-center">
                                <div>
                                    <h3 class="section-title">AI Insights & Recommendations</h3>
                                    <p class="section-subtitle">Data-driven insights from InsightGeneratorService</p>
                                </div>
                                <button class="btn btn-sm btn-outline" @click="refreshInsights" :class="{ 'loading': loadingInsights }">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" x-show="!loadingInsights"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    <span class="btn-spinner" x-show="loadingInsights"></span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div x-show="loadingInsights" class="d-flex justify-center p-6">
                                <div class="loading"></div>
                            </div>
                            
                            <div x-show="!loadingInsights">
                                <template x-for="(insight, index) in dashboardInsights" :key="insight.id">
                                    <div class="alert mb-3" :class="getInsightAlertClass(insight.type)">
                                        <div class="d-flex justify-between align-center mb-2">
                                            <div class="d-flex align-center gap-2">
                                                <span class="badge" :class="getPriorityBadgeClass(insight.priority)" x-text="'Priority ' + insight.priority"></span>
                                                <span class="text-xs text-muted" x-text="insight.source"></span>
                                            </div>
                                        </div>
                                        <div class="mb-2" x-html="insight.message"></div>
                                        <div class="d-flex gap-2 mt-3" x-show="insight.actions && insight.actions.length > 0">
                                            <template x-for="action in insight.actions" :key="action.label">
                                                <button class="btn btn-sm" :class="action.method === 'POST' ? 'btn-primary' : 'btn-secondary'" @click="executeInsightAction(insight.id, action)">
                                                    <span x-text="action.label"></span>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                
                                <div x-show="dashboardInsights.length === 0" class="empty-state">
                                    <div class="empty-state-icon">✓</div>
                                    <div class="empty-state-title">All Systems Optimal</div>
                                    <div class="empty-state-description">No critical insights at the moment. AI is continuously analyzing your data.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                   <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-between align-center">
                                <div>
                                    <h3 class="section-title">Top Opportunities</h3>
                                    <p class="section-subtitle">SpiderWeb AI opportunity detection (5 patterns)</p>
                                </div>
                                <button class="btn btn-sm btn-outline" @click="refreshOpportunities" :class="{ 'loading': loadingOpportunities }">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" x-show="!loadingOpportunities"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    <span class="btn-spinner" x-show="loadingOpportunities"></span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div x-show="loadingOpportunities" class="d-flex justify-center p-6">
                                <div class="loading"></div>
                            </div>
                            
                            <div x-show="!loadingOpportunities">
                                <template x-for="(opp, index) in opportunities.slice(0, 8)" :key="opp.id">
                                    <div class="insight-card mb-3" :class="getOpportunityClass(opp.type)">
                                        <div class="insight-card-header">
                                            <div class="d-flex align-center gap-2">
                                                <span class="text-xs text-muted">#<span x-text="index + 1"></span></span>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <div class="badge badge-danger text-xs" x-text="'Priority: ' + opp.priority"></div>
                                                <div class="badge badge-success text-xs" x-text="Math.round(opp.conversion_probability * 100) + '% prob'"></div>
                                            </div>
                                        </div>
                                        <div class="insight-card-body">
                                            <h4 class="insight-title" x-text="opp.lead_name"></h4>
                                            <p class="insight-message text-sm mb-2">
                                                <strong x-text="opp.type.replace(/_/g, ' ')"></strong>
                                                <span x-show="opp.behavioral_score"> | Score: <span class="font-semibold" x-text="Math.round(opp.behavioral_score)"></span></span>
                                            </p>
                                            <div class="text-xs text-muted mb-3" x-show="opp.property_address">
                                                Property: <span x-text="opp.property_address"></span>
                                            </div>
                                            <div class="insight-actions-grid">
                                                <template x-for="action in opp.action_sequence" :key="action.action">
                                                    <button class="btn btn-sm" :class="getActionButtonClass(action.action)" @click="executeAction(opp.id, action.action, opp.lead_email)" :class="{ 'loading': executingAction === opp.id + '-' + action.action }">
                                                        <span x-show="executingAction !== opp.id + '-' + action.action" x-text="action.description"></span>
                                                        <span class="btn-spinner" x-show="executingAction === opp.id + '-' + action.action"></span>
                                                    </button>
                                                </template>
                                            </div>
                                            <div class="ai-narration" x-show="opp.urgency_score > 0.8">
                                                AI Analysis: High urgency detected. Immediate contact recommended for maximum conversion probability.
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                
                                <div x-show="opportunities.length === 0" class="empty-state">
                                    <div class="empty-state-icon">✓</div>
                                    <div class="empty-state-title">All Caught Up!</div>
                                    <div class="empty-state-description">No urgent opportunities at the moment. SpiderWeb AI is continuously monitoring.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="section-title">Behavioral Intelligence</h3>
                            <p class="section-subtitle">3-dimensional scoring: Urgency × Financial × Engagement</p>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-column gap-4">
                                <div>
                                    <div class="d-flex justify-between align-center mb-2">
                                        <div class="text-sm text-muted">Average Behavioral Score</div>
                                        <div class="text-3xl font-bold" x-text="Math.round(behavioralMetrics.average_score || 0)"></div>
                                    </div>
                                    <div class="progress"><div class="progress-bar" :class="(behavioralMetrics.average_score || 0) >= 70 ? 'success' : (behavioralMetrics.average_score || 0) >= 40 ? 'warning' : 'danger'" :style="`width: ${behavioralMetrics.average_score || 0}%`"></div></div>
                                </div>
                                
                                <div class="d-grid grid-cols-2 gap-3">
                                    <div class="text-center p-3 bg-gray-50 rounded">
                                        <div class="text-sm text-muted">High Score Leads</div>
                                        <div class="text-2xl font-bold" x-text="behavioralMetrics.high_score_count || 0"></div>
                                        <div class="text-xs text-muted">Score ≥ 70</div>
                                    </div>
                                    
                                    <div class="text-center p-3 bg-gray-50 rounded">
                                        <div class="text-sm text-muted">Medium Score</div>
                                        <div class="text-2xl font-bold" x-text="behavioralMetrics.medium_score_leads || 0"></div>
                                        <div class="text-xs text-muted">Score 40-69</div>
                                    </div>
                                    
                                    <div class="text-center p-3 bg-gray-50 rounded">
                                        <div class="text-sm text-muted">Conversions (MTD)</div>
                                        <div class="text-2xl font-bold" x-text="behavioralMetrics.conversions_this_month || 0"></div>
                                        <div class="text-xs text-muted">This month</div>
                                    </div>
                                    
                                    <div class="text-center p-3 bg-gray-50 rounded">
                                        <div class="text-sm text-muted">Prediction Accuracy</div>
                                        <div class="text-2xl font-bold" x-text="Math.round(behavioralMetrics.prediction_accuracy || 0) + '%'"></div>
                                        <div class="text-xs text-muted">Model accuracy</div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="text-sm font-medium mb-2">Active Behavioral Triggers</div>
                                    <template x-for="trigger in activeTriggers.slice(0, 3)" :key="trigger.trigger_name">
                                        <div class="d-flex justify-between align-center p-2 bg-gray-50 rounded mb-2">
                                            <div class="flex-1">
                                                <div class="text-sm font-medium" x-text="trigger.trigger_name"></div>
                                                <div class="text-xs text-muted" x-text="trigger.condition"></div>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <span class="badge badge-primary" x-text="trigger.active_count + ' leads'"></span>
                                                <span class="badge badge-success" x-text="trigger.conversion_rate + '%'"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
               <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Behavioral Trends & Analytics</h2>
                        <select class="form-control" x-model="trendsTimeRange" @change="fetchTrends" style="width: 120px;">
                            <option value="7">7 Days</option>
                            <option value="30">30 Days</option>
                            <option value="90">90 Days</option>
                        </select>
                    </div>
                    
                    <div class="dashboard-grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Behavioral Trends</h3>
                                <p class="text-sm text-muted">Active Users, Engagement, Conversions</p>
                            </div>
                            <div class="card-body">
                                <canvas x-ref="trendsChart" class="chart-md"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Activity Heatmap</h3>
                                <p class="text-sm text-muted">Day of week × Hour of day</p>
                            </div>
                            <div class="card-body">
                                <div class="d-flex">
                                    <div class="heatmap-labels">
                                        <div class="heatmap-label">Sun</div>
                                        <div class="heatmap-label">Mon</div>
                                        <div class="heatmap-label">Tue</div>
                                        <div class="heatmap-label">Wed</div>
                                        <div class="heatmap-label">Thu</div>
                                        <div class="heatmap-label">Fri</div>
                                        <div class="heatmap-label">Sat</div>
                                    </div>
                                    <div class="flex-1">
                                        <template x-for="day in 7" :key="day">
                                            <div class="heatmap-grid mb-1">
                                                <template x-for="hour in 24" :key="hour">
                                                    <div class="heatmap-cell" :style="`background-color: ${getHeatmapColor(day - 1, hour - 1)}`" :title="`${getDayName(day - 1)} ${hour - 1}:00 - Activity: ${getHeatmapActivity(day - 1, hour - 1)}`"></div>
                                                </template>
                                            </div>
                                        </template>
                                        <div class="text-xs text-muted text-center mt-2">
                                            0:00 → 23:00
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="section-title">Conversion Funnel</h3>
                            <p class="section-subtitle">Overall: <span class="font-semibold text-success" x-text="(funnelData.conversion_rate || 0).toFixed(1) + '%'"></span></p>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-column gap-3">
                                <template x-for="(stage, index) in funnelData.funnel || []" :key="stage.stage">
                                    <div>
                                        <div class="d-flex justify-between align-center mb-1">
                                            <div class="d-flex align-center gap-2">
                                                <span class="badge badge-primary" x-text="index + 1"></span>
                                                <span class="text-sm font-semibold" x-text="formatStageName(stage.stage)"></span>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <span class="badge badge-info" x-text="stage.count + ' leads'"></span>
                                                <span class="badge" :class="stage.percentage >= 70 ? 'badge-success' : stage.percentage >= 40 ? 'badge-warning' : 'badge-danger'" x-text="stage.percentage.toFixed(0) + '%'"></span>
                                            </div>
                                        </div>
                                        <div class="progress"><div class="progress-bar" :style="`width: ${stage.percentage}%; background: linear-gradient(90deg, var(--navy-primary), var(--gold-primary));`"></div></div>
                                        <div class="d-flex justify-between text-xs text-muted mt-1">
                                            <span>Next stage: <span x-text="stage.conversion_rate.toFixed(1) + '%'"></span></span>
                                            <span>Avg time: <span x-text="formatTime(stage.avg_time_in_stage)"></span></span>
                                        </div>
                                        <div x-show="stage.conversion_rate < 30" class="alert alert-warning mt-2 p-2 text-xs">
                                            Bottleneck detected - Low conversion to next stage
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="section-title">Behavioral Segments</h3>
                            <p class="section-subtitle">Lead distribution by engagement level</p>
                        </div>
                        <div class="card-body">
                            <canvas x-ref="segmentsChart" class="chart-md"></canvas>
                            
                            <div class="mt-4">
                                <template x-for="segment in behavioralSegments" :key="segment.segment">
                                    <div class="d-flex justify-between align-center p-2 border-b">
                                        <div class="flex-1">
                                            <div class="font-medium text-sm" x-text="segment.segment.replace('_', ' ')"></div>
                                            <div class="text-xs text-muted">Avg session: <span x-text="Math.round(segment.avg_session_length / 60) + ' min'"></span></div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <span class="badge badge-info" x-text="segment.lead_count + ' leads'"></span>
                                            <span class="badge badge-success" x-text="segment.conversion_rate.toFixed(1) + '%'"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
               <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Houston Market Intelligence</h2>
                    </div>
                    
                    <div class="dashboard-grid-3">
                        <template x-for="neighborhood in houstonMarket" :key="neighborhood.neighborhood">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="font-semibold mb-2" x-text="neighborhood.neighborhood"></h4>
                                    
                                    <div class="d-flex gap-2 mb-3">
                                        <span class="badge badge-primary text-xs">
                                            Score: <span x-text="neighborhood.avg_behavioral_score"></span>
                                        </span>
                                        <span class="badge badge-success text-xs">
                                            <span x-text="neighborhood.conversion_rate"></span>% conversion
                                        </span>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <div class="text-xs text-muted">Price Range</div>
                                        <div class="font-semibold text-sm" x-text="neighborhood.avg_price_range"></div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <div class="text-xs text-muted">Demographics</div>
                                        <div class="text-sm" x-text="formatDemographic(neighborhood.primary_demographic)"></div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="text-xs text-muted">Active Leads</div>
                                        <div class="font-semibold" x-text="neighborhood.lead_count"></div>
                                    </div>
                                    
                                    <div class="text-xs">
                                        <div class="text-muted mb-1">Key Attributes:</div>
                                        <div class="d-flex flex-wrap gap-1">
                                            <template x-for="attr in neighborhood.key_attributes" :key="attr">
                                                <span class="badge badge-secondary" style="font-size: 10px;" x-text="formatAttribute(attr)"></span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Performance Metrics Dashboard</h2>
                    </div>
                    
                    <div class="dashboard-grid-4">
                        <div class="stat-card">
                            <div class="stat-card-label">Pending Bookings</div>
                            <div class="stat-card-value" x-text="warmStats.pending_bookings || 0"></div>
                            <div class="stat-card-subtitle">Awaiting confirmation</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Pending Applications</div>
                            <div class="stat-card-value" x-text="warmStats.pending_applications || 0"></div>
                            <div class="stat-card-subtitle">In review</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">30-Day Lead Conversion</div>
                            <div class="stat-card-value" x-text="(dailyStats.conversion_rate || 0).toFixed(1) + '%'"></div>
                            <div class="stat-card-change" :class="dailyStats.conversion_rate > 20 ? 'positive' : 'negative'">
                                <span x-text="dailyStats.conversion_rate > 20 ? '+' : ''"></span>
                                <span x-text="dailyStats.conversion_rate > 20 ? '↑' : '↓'"></span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Applications Today</div>
                            <div class="stat-card-value" x-text="dailyStats.applications_count || 0"></div>
                            <div class="stat-card-subtitle">
                                vs <span x-text="dailyStats.yesterday_applications || 0"></span> yesterday
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Booking Analytics</h2>
                    </div>
                    
                    <div class="dashboard-grid-3">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">7-Day Booking Trends</h3>
                            </div>
                            <div class="card-body">
                                <canvas x-ref="bookingTrendsChart" class="chart-sm"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Booking Sources</h3>
                            </div>
                            <div class="card-body">
                                <canvas x-ref="bookingSourcesChart" class="chart-sm"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Popular Time Slots</h3>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2">
                                    <template x-for="slot in timeSlots.slice(0, 6)" :key="slot.time">
                                        <div>
                                            <div class="d-flex justify-between text-sm mb-1">
                                                <span x-text="slot.time"></span>
                                                <span class="font-semibold" x-text="slot.bookings + ' bookings'"></span>
                                            </div>
                                            <div class="progress" style="height: 8px;"><div class="progress-bar" :style="`width: ${slot.popularity}%`"></div></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
               <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">AI Recommendations</h2>
                    </div>
                    
                    <div class="dashboard-grid-3">
                        <template x-for="rec in aiRecommendations.slice(0, 6)" :key="rec.id">
                            <div class="task-card" :class="rec.priority === 'urgent' ? 'urgent' : rec.priority === 'high' ? 'important' : 'optional'">
                                <div class="task-card-header">
                                    <span class="task-card-priority" :class="rec.priority" x-text="rec.priority"></span>
                                </div>
                                <div class="task-card-title" x-text="rec.title"></div>
                                <div class="task-card-description" x-text="rec.description"></div>
                                <div class="mb-2">
                                    <span class="badge badge-info text-xs">
                                        <span x-text="Math.round(rec.confidence * 100)"></span>% confidence
                                    </span>
                                    <span x-show="rec.potential_revenue" class="badge badge-success text-xs ml-1">
                                        <span x-text="formatCurrency(rec.potential_revenue)"></span> potential
                                    </span>
                                </div>
                                <div class="task-card-actions">
                                    <template x-for="action in rec.action_items" :key="action.action">
                                        <button class="btn btn-sm btn-primary" @click="executeRecommendation(rec.id, action.action)">
                                            <span x-text="action.description"></span>
                                        </button>
                                    </template>
                                    <button class="btn btn-sm btn-outline" @click="dismissRecommendation(rec.id)">
                                        Dismiss
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Anomalies & Alerts</h2>
                    </div>
                    
                    <div class="dashboard-grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Behavioral Anomalies</h3>
                            </div>
                            <div class="card-body">
                                <template x-for="anomaly in behavioralAnomalies.slice(0, 5)" :key="anomaly.id">
                                    <div class="d-flex justify-between align-center p-3 border rounded mb-2">
                                        <div class="flex-1">
                                            <div class="d-flex gap-2 mb-1">
                                                <span class="badge" :class="getSeverityBadge(anomaly.severity)" x-text="anomaly.severity"></span>
                                                <span class="text-xs text-muted" x-text="anomaly.anomaly_type"></span>
                                            </div>
                                            <div class="text-sm" x-text="anomaly.description"></div>
                                            <div class="text-xs text-muted mt-1">
                                                Detected: <span x-text="formatTimeAgo(anomaly.detected_at)"></span>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-primary" @click="acknowledgeAnomaly(anomaly.id)">
                                            Acknowledge
                                        </button>
                                    </div>
                                </template>
                                
                                <div x-show="behavioralAnomalies.length === 0" class="text-center text-muted p-4">
                                    ✓ No anomalies detected
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">System Alerts</h3>
                            </div>
                            <div class="card-body">
                                <template x-for="alert in systemAlerts.slice(0, 5)" :key="alert.id">
                                    <div class="alert" :class="`alert-${alert.severity}`">
                                        <div class="font-medium text-sm" x-text="alert.title"></div>
                                        <div class="text-xs mt-1" x-text="alert.message"></div>
                                    </div>
                                </template>
                                
                                <div x-show="systemAlerts.length === 0" class="text-center text-success p-4">
                                    ✓ All systems operational
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="section-title">Lead Source Breakdown</h3>
                        </div>
                        <div class="card-body">
                            <canvas x-ref="leadSourceChart" class="chart-md"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="section-title">Property Type Distribution</h3>
                        </div>
                        <div class="card-body">
                            <canvas x-ref="propertyTypeChart" class="chart-md"></canvas>
                        </div>
                    </div>
                </div>
               <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Security & System Health</h2>
                    </div>
                    
                    <div class="dashboard-grid-4">
                        <div class="stat-card stat-card-mini">
                            <div class="stat-card-label">System Uptime</div>
                            <div class="stat-card-value" x-text="systemHealth.uptime_percent + '%'"></div>
                        </div>
                        
                        <div class="stat-card stat-card-mini">
                            <div class="stat-card-label">Avg Response Time</div>
                            <div class="stat-card-value" x-text="systemHealth.avg_response_time_ms + 'ms'"></div>
                        </div>
                        
                        <div class="stat-card stat-card-mini">
                            <div class="stat-card-label">Error Rate</div>
                            <div class="stat-card-value" x-text="systemHealth.error_rate_percent + '%'"></div>
                        </div>
                        
                        <div class="stat-card stat-card-mini">
                            <div class="stat-card-label">Security Events (24h)</div>
                            <div class="stat-card-value" x-text="securityMetrics.total_events || 0"></div>
                        </div>
                        
                        <div class="stat-card stat-card-mini">
                            <div class="stat-card-label">Active Sessions</div>
                            <div class="stat-card-value" x-text="realtimeStats.active_sessions || 0"></div>
                        </div>
                        
                        <div class="stat-card stat-card-mini">
                            <div class="stat-card-label">API Requests/min</div>
                            <div class="stat-card-value" x-text="realtimeStats.api_requests_per_minute || 0"></div>
                        </div>
                        
                        <div class="stat-card stat-card-mini">
                            <div class="stat-card-label">FUB Sync Status</div>
                            <div class="stat-card-value text-sm">
                                <span class="status-badge" :class="realtimeStats.fub_sync_status === 'synced' ? 'status-ok' : 'status-warning'" x-text="realtimeStats.fub_sync_status || 'unknown'"></span>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-card-mini">
                            <div class="stat-card-label">Queue Sizes</div>
                            <div class="text-sm">
                                <div>Email: <span class="font-semibold" x-text="realtimeStats.queue_sizes?.email_queue || 0"></span></div>
                                <div>Webhook: <span class="font-semibold" x-text="realtimeStats.queue_sizes?.webhook_queue || 0"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Email Processing & Automation</h2>
                    </div>
                    
                    <div class="dashboard-grid-3">
                        <div class="stat-card">
                            <div class="stat-card-label">Trusted Senders</div>
                            <div class="stat-card-value" x-text="emailStats.total_senders || 0"></div>
                            <div class="stat-card-subtitle">
                                <span x-text="emailStats.active_senders || 0"></span> active
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Emails Processed (30d)</div>
                            <div class="stat-card-value" x-text="emailStats.processing_stats?.total_processed || 0"></div>
                            <div class="stat-card-subtitle">
                                <span class="text-success" x-text="emailStats.processing_stats?.successful || 0"></span> successful
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Auto-Processed</div>
                            <div class="stat-card-value" x-text="emailStats.processing_stats?.auto_processed || 0"></div>
                            <div class="stat-card-subtitle">
                                <span x-text="emailStats.processing_stats?.manual_review || 0"></span> need review
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="section-title">Webhook Activity</h3>
                            <div class="d-flex align-center gap-2 mt-1">
                                <span class="text-xs text-muted">
                                    <span x-text="webhookStats.recent_events || 0"></span> events (24h)
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-grid grid-cols-3 gap-3 mb-4">
                                <div class="text-center">
                                    <div class="text-sm text-muted">Total</div>
                                    <div class="text-2xl font-bold" x-text="webhookStats.total_events || 0"></div>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-muted">Processed</div>
                                    <div class="text-2xl font-bold" x-text="getWebhookStatusCount('processed')"></div>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-muted">Failed</div>
                                    <div class="text-2xl font-bold" x-text="getWebhookStatusCount('failed')"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="text-sm font-medium mb-2">By Source</div>
                                <template x-for="source in webhookStats.source_breakdown" :key="source.source">
                                    <div class="d-flex justify-between p-2 bg-gray-50 rounded mb-1">
                                        <span class="text-sm" x-text="source.source"></span>
                                        <span class="badge badge-info" x-text="source.count"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-between align-center">
                                <h3 class="section-title">Recent Activity</h3>
                                <button class="btn btn-sm btn-outline" @click="toggleActivityPolling">
                                    <span x-show="activityPolling">Pause</span>
                                    <span x-show="!activityPolling">Resume</span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed">
                                <template x-for="activity in recentActivity.slice(0, 12)" :key="activity.id">
                                    <div class="activity-item">
                                        <div class="activity-icon" :style="`background-color: ${getActivityColor(activity.type)}`">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" :d="getActivityIconPath(activity.type)"></path></svg>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-title" x-text="activity.title"></div>
                                            <div class="activity-description" x-text="activity.description"></div>
                                            <div class="activity-time" x-text="formatTimeAgo(activity.timestamp)"></div>
                                        </div>
                                    </div>
                                </template>
                                
                                <div x-show="recentActivity.length === 0" class="empty-state">
                                    <div class="empty-state-description">No recent activity</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
               <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Property Status Overview</h2>
                    </div>
                    
                    <div class="dashboard-grid-4">
                        <div class="stat-card">
                            <div class="stat-card-label">Total Properties</div>
                            <div class="stat-card-value" x-text="propertyStats.total_properties || 0"></div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Active Listings</div>
                            <div class="stat-card-value" x-text="propertyStats.active_properties || 0"></div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Pending Images</div>
                            <div class="stat-card-value" x-text="propertyStats.pending_properties || 0"></div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Average Price</div>
                            <div class="stat-card-value" x-text="formatCurrency(propertyStats.average_price)"></div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Total Portfolio Value</div>
                            <div class="stat-card-value" x-text="formatCurrency(propertyStats.total_value)"></div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Views (30d)</div>
                            <div class="stat-card-value" x-text="(propertyStats.views_last_30_days || 0).toLocaleString()"></div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Sold Properties</div>
                            <div class="stat-card-value" x-text="propertyStats.sold_properties || 0"></div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Avg Days on Market</div>
                            <div class="stat-card-value" x-text="(propertyStats.avg_days_on_market || 28) + 'd'"></div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Today's Schedule</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="d-grid grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-semibold mb-3">
                                        <span x-text="todaySchedule.greeting"></span>, <span x-text="todaySchedule.agent_name"></span>
                                    </h4>
                                    <div class="text-sm text-muted mb-3" x-text="todaySchedule.formatted_date"></div>
                                    
                                    <div class="d-grid grid-cols-3 gap-3 mb-4">
                                        <div class="text-center p-2 bg-gray-50 rounded">
                                            <div class="text-xs text-muted">Total</div>
                                            <div class="text-xl font-bold" x-text="todaySchedule.total_showings || 0"></div>
                                        </div>
                                        <div class="text-center p-2 bg-success-light rounded">
                                            <div class="text-xs text-muted">Confirmed</div>
                                            <div class="text-xl font-bold" x-text="todaySchedule.confirmed_showings || 0"></div>
                                        </div>
                                        <div class="text-center p-2 bg-warning-light rounded">
                                            <div class="text-xs text-muted">Pending</div>
                                            <div class="text-xl font-bold" x-text="todaySchedule.pending_showings || 0"></div>
                                        </div>
                                    </div>
                                    
                                    <div x-show="todaySchedule.urgent_todos > 0" class="alert alert-danger p-3">
                                        <strong><span x-text="todaySchedule.urgent_todos"></span> Urgent To-Dos</strong>
                                    </div>
                                    
                                    <div x-show="todaySchedule.overdue_items > 0" class="alert alert-warning p-3">
                                        <strong><span x-text="todaySchedule.overdue_items"></span> Overdue Items</strong>
                                    </div>
                                </div>
                                
                                <div>
                                    <div x-show="todaySchedule.next_appointment">
                                        <h4 class="font-semibold mb-2">Next Appointment</h4>
                                        <div class="p-3 bg-primary text-white rounded mb-3">
                                            <div class="text-2xl font-bold mb-1" x-text="todaySchedule.next_appointment?.time"></div>
                                            <div class="text-sm" x-text="todaySchedule.next_appointment?.property"></div>
                                            <div class="text-xs mt-1" x-text="'Client: ' + (todaySchedule.next_appointment?.client || 'TBD')"></div>
                                        </div>
                                    </div>
                                    
                                    <div x-show="todaySchedule.top_priority_todo">
                                        <h4 class="font-semibold mb-2">Top Priority</h4>
                                        <div class="task-card urgent">
                                            <div class="task-card-header">
                                                <span class="task-card-priority urgent">URGENT</span>
                                            </div>
                                            <div class="task-card-title" x-text="todaySchedule.top_priority_todo?.title"></div>
                                            <div class="text-xs text-muted" x-text="'Due: ' + formatTimeAgo(todaySchedule.top_priority_todo?.due)"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Funnel Metrics (30 Days)</h2>
                    </div>
                    
                    <div class="dashboard-grid-4">
                        <div class="stat-card">
                            <div class="stat-card-label">Visitors</div>
                            <div class="stat-card-value" x-text="(funnelMetrics.visitors || 0).toLocaleString()"></div>
                            <div class="stat-card-subtitle">Unique sessions</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Leads</div>
                            <div class="stat-card-value" x-text="(funnelMetrics.leads || 0).toLocaleString()"></div>
                            <div class="stat-card-change positive">
                                <span x-text="calculateConversionRate(funnelMetrics.leads, funnelMetrics.visitors)"></span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Applications</div>
                            <div class="stat-card-value" x-text="(funnelMetrics.applications || 0).toLocaleString()"></div>
                            <div class="stat-card-change positive">
                                <span x-text="calculateConversionRate(funnelMetrics.applications, funnelMetrics.leads)"></span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-label">Conversions</div>
                            <div class="stat-card-value" x-text="(funnelMetrics.conversions || 0).toLocaleString()"></div>
                            <div class="stat-card-change positive">
                                <span x-text="calculateConversionRate(funnelMetrics.conversions, funnelMetrics.applications)"></span>
                            </div>
                        </div>
                    </div>
                </div>
               <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Lead Source Performance</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Source</th>
                                            <th>Total Leads</th>
                                            <th>Conversion Rate</th>
                                            <th>Avg Behavioral Score</th>
                                            <th>Revenue Generated</th>
                                            <th>Performance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="source in leadSources" :key="source.source">
                                            <tr>
                                                <td>
                                                    <span class="badge badge-info" x-text="source.source"></span>
                                                </td>
                                                <td class="font-semibold" x-text="source.count"></td>
                                                <td>
                                                    <span class="font-semibold" x-text="source.conversion_rate.toFixed(1) + '%'"></span>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-center gap-2">
                                                        <span x-text="source.avg_score || 65"></span>
                                                        <div class="progress" style="width: 80px; height: 4px;"><div class="progress-bar" :class="(source.avg_score || 65) >= 70 ? 'success' : 'warning'" :style="`width: ${source.avg_score || 65}%`"></div></div>
                                                    </div>
                                                </td>
                                                <td x-text="formatCurrency((source.count || 0) * 2800)"></td>
                                                <td>
                                                    <span class="badge" :class="source.conversion_rate >= 30 ? 'badge-success' : source.conversion_rate >= 20 ? 'badge-warning' : 'badge-danger'" x-text="source.conversion_rate >= 30 ? 'Excellent' : source.conversion_rate >= 20 ? 'Good' : 'Needs Improvement'"></span>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Identified Behavioral Patterns</h2>
                    </div>
                    
                    <div class="dashboard-grid-2">
                        <template x-for="pattern in identifiedPatterns" :key="pattern.pattern_name">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-between align-center mb-2">
                                        <h4 class="font-semibold" x-text="pattern.pattern_name"></h4>
                                        <div class="d-flex gap-1">
                                            <span class="badge badge-info text-xs">
                                                <span x-text="Math.round(pattern.confidence * 100)"></span>% confidence
                                            </span>
                                            <span class="badge text-xs" :class="pattern.impact === 'high' ? 'badge-danger' : 'badge-warning'" x-text="pattern.impact + ' impact'"></span>
                                        </div>
                                    </div>
                                    <p class="text-sm text-muted mb-2" x-text="pattern.description"></p>
                                    <div class="text-xs">
                                        <span class="text-muted">Affecting</span>
                                        <span class="font-semibold" x-text="pattern.lead_count + ' leads'"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Revenue & Performance Projections</h2>
                    </div>
                    
                    <div class="dashboard-grid-3">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">This Month</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="text-sm text-muted">Revenue</div>
                                    <div class="text-3xl font-bold">$127K</div>
                                </div>
                                <div class="mb-3">
                                    <div class="text-sm text-muted">Projected (EOM)</div>
                                    <div class="text-xl font-semibold">$185K</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">vs Last Month</div>
                                    <div class="text-xs font-semibold text-success">+18.5% ↑</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Pipeline Value</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="text-sm text-muted">In Pipeline</div>
                                    <div class="text-3xl font-bold">$450K</div>
                                </div>
                                <div class="mb-3">
                                    <div class="text-sm text-muted">Expected Close (30d)</div>
                                    <div class="text-xl font-semibold">$220K</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Confidence</div>
                                    <div class="text-xs font-semibold text-success">78% ↑</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">ROI Analysis</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="text-sm text-muted">Overall ROI</div>
                                    <div class="text-3xl font-bold">247%</div>
                                </div>
                                <div class="mb-3">
                                    <div class="text-sm text-muted">Cost Savings</div>
                                    <div class="text-xl font-semibold">$340K</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Automation Rate</div>
                                    <div class="text-xs font-semibold text-success">68% ↑</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">System Notifications & Monitoring</h2>
                    </div>
                    
                    <div class="dashboard-grid-3">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Pre-Listing Pipeline</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-between">
                                        <span class="text-sm">Total Items</span>
                                        <span class="font-semibold" x-text="preListingStats.total_items || 0"></span>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-between text-sm">
                                        <span>Photos Pending</span>
                                        <span class="font-semibold" x-text="preListingStats.photos_pending || 0"></span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-between text-sm">
                                        <span>MLS Listed</span>
                                        <span class="font-semibold" x-text="preListingStats.mls_listed || 0"></span>
                                    </div>
                                </div>
                                <div x-show="preListingStats.overdue_count > 0" class="alert alert-danger p-2 text-xs">
                                    <strong><span x-text="preListingStats.overdue_count"></span> Overdue</strong>
                                </div>
                                <button class="btn btn-sm btn-primary btn-block mt-2" @click="window.location.href='/admin/pre-listing'">
                                    Manage Pipeline
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">HAR Market Data</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="text-sm text-muted">Total Reports</div>
                                    <div class="text-2xl font-bold" x-text="harStats.total_reports || 0"></div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-between text-sm">
                                        <span>Successful Scrapes</span>
                                        <span class="text-success" x-text="harStats.successful_scrapes || 0"></span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-between text-sm">
                                        <span>Failed Scrapes</span>
                                        <span class="text-danger" x-text="harStats.failed_scrapes || 0"></span>
                                    </div>
                                </div>
                                <div class="text-xs text-muted">
                                    Last updated: <span x-text="formatTimeAgo(harStats.last_scrape_at)"></span>
                                </div>
                                <button class="btn btn-sm btn-secondary btn-block mt-3" @click="triggerHARScrape" :class="{ 'loading': scrapingHAR }">
                                    <span x-show="!scrapingHAR">Update Market Data</span>
                                    <span class="btn-spinner" x-show="scrapingHAR"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Abandonment Recovery</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="text-sm text-muted">Active Recoveries</div>
                                    <div class="text-2xl font-bold" x-text="abandonmentStats.active_recoveries || 0"></div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-between text-sm">
                                        <span>Recovery Rate</span>
                                        <span class="font-semibold">32%</span>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-between text-sm">
                                        <span>Emails Sent (24h)</span>
                                        <span class="font-semibold" x-text="abandonmentStats.emails_sent_24h || 0"></span>
                                    </div>
                                </div>
                                <div class="text-xs text-muted">
                                    Last recovery: <span x-text="formatTimeAgo(abandonmentStats.last_recovery_at)"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <div class="toast-container" x-data="toastManager()">
            <template x-for="toast in toasts" :key="toast.id">
                <div class="toast" :class="`toast-${toast.type}`" x-show="toast.visible" x-transition:enter="transition-fast" x-transition:leave="transition-fast">
                    <div class="toast-icon" x-text="getToastIcon(toast.type)"></div>
                    <div class="toast-message" x-text="toast.message"></div>
                    <button class="toast-close" @click="remove(toast.id)">×</button>
                </div>
            </template>
        </div>
    </div>
    <script>
        function dashboardData() {
            return {
                liveStats: { active_users: 0, unread_messages: 0, current_showings: 0 },
                warmStats: { pending_bookings: 0, pending_applications: 0 },
                dailyStats: { applications_count: 0, conversion_rate: 0, yesterday_applications: 0 },
                hotLeads: 0,
                dashboardInsights: [],
                opportunities: [],
                behavioralMetrics: { average_score: 0, high_score_count: 0, medium_score_leads: 0, conversions_this_month: 0, prediction_accuracy: 0 },
                loadingInsights: true,
                activeTriggers: [],
                funnelData: { funnel: [], conversion_rate: 0 },
                funnelMetrics: { visitors: 0, leads: 0, applications: 0, conversions: 0 },
                trendsData: { active_users: [], engagement: [], conversions: [] },
                behavioralSegments: [],
                heatmapData: [],
                houstonMarket: [],
                aiRecommendations: [],
                behavioralAnomalies: [],
                systemAlerts: [],
                leadSources: [],
                identifiedPatterns: [],
                recentActivity: [],
                propertyStats: {},
                todaySchedule: {},
                systemHealth: { uptime_percent: 99.9, avg_response_time_ms: 120, error_rate_percent: 0.1 },
                securityMetrics: { total_events: 0 },
                realtimeStats: { active_sessions: 0, api_requests_per_minute: 0, fub_sync_status: 'synced', queue_sizes: {} },
                emailStats: { total_senders: 0, active_senders: 0, processing_stats: {} },
                webhookStats: { total_events: 0, recent_events: 0, status_breakdown: [], source_breakdown: [] },
                preListingStats: { total_items: 0, photos_pending: 0, mls_listed: 0, overdue_count: 0 },
                harStats: { total_reports: 0, successful_scrapes: 0, failed_scrapes: 0, last_scrape_at: new Date().toISOString() },
                abandonmentStats: { active_recoveries: 0, emails_sent_24h: 0, last_recovery_at: new Date().toISOString() },
                timeSlots: [],
                sidebarCounts: { total_leads: 0, hot_leads: 0, warm_leads: 0, active_properties: 0, pending_applications: 0, confirmed_bookings: 0, closing_pipeline: 0, pending_images: 0 },
                trendsTimeRange: 30,
                activityPolling: true,
                loadingOpportunities: true,
                executingAction: null,
                searchQuery: '',
                scrapingHAR: false,
                liveStatsInterval: null,
                hotStatsInterval: null,
                warmStatsInterval: null,
                activityInterval: null,
                trendsChart: null,
                segmentsChart: null,
                bookingTrendsChart: null,
                bookingSourcesChart: null,
                leadSourceChart: null,
                propertyTypeChart: null,
                
                userProfile: { username: 'Loading...', role: 'Loading...', initials: 'U' },
                
                async init() {
                    await this.fetchUserProfile();
                    await Promise.all([
                        this.fetchDashboardInsights(),
                        this.fetchLiveStats(),
                        this.fetchHotStats(),
                        this.fetchWarmStats(),
                        this.fetchDailyStats(),
                        this.fetchBehavioralIntelligence(),
                        this.fetchFunnel(),
                        this.fetchTrends(),
                        this.fetchBehavioralSegments(),
                        this.fetchHeatmap(),
                        this.fetchHoustonMarket(),
                        this.fetchAIRecommendations(),
                        this.fetchAnomalies(),
                        this.fetchPropertyStats(),
                        this.fetchTodaySchedule(),
                        this.fetchSystemHealth(),
                        this.fetchRealtimeStats(),
                        this.fetchEmailStats(),
                        this.fetchWebhookStats(),
                        this.fetchPreListingStats(),
                        this.fetchHARStats(),
                        this.fetchRecentActivity()
                    ]);
                    this.renderCharts();
                    this.startPolling();
                },
                
                async fetchUserProfile() {
                    try {
                        const response = await fetch('/api/admin/settings/profile');
                        const data = await response.json();
                        this.userProfile = {
                            username: data.username || 'User',
                            role: data.role || 'Unknown',
                            initials: this.getUserInitials(data.username)
                        };
                    } catch (error) {
                        console.error('Failed to fetch user profile:', error);
                        this.userProfile = { username: 'User', role: 'Unknown', initials: 'U' };
                    }
                },
                
                getUserInitials(name) {
                    if (!name) return 'U';
                    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                },
                
                async fetchDashboardInsights() {
                    this.loadingInsights = true;
                    try {
                        const response = await fetch('/api/v1/behavioral/insights');
                        const data = await response.json();
                        this.dashboardInsights = data.insights || [];
                        this.loadingInsights = false;
                    } catch (error) {
                        console.error('Failed to fetch dashboard insights:', error);
                        this.loadingInsights = false;
                    }
                },
                
                async refreshInsights() {
                    await this.fetchDashboardInsights();
                },
                
                async fetchLiveStats() {
                    try {
                        const response = await fetch('/api/stats/live');
                        const data = await response.json();
                        this.liveStats = data;
                    } catch (error) {
                        console.error('Failed to fetch live stats:', error);
                    }
                },
                
                async fetchHotStats() {
                    try {
                        const response = await fetch('/api/stats/hot');
                        const data = await response.json();
                        this.opportunities = data.top_opportunities || [];
                        this.warmStats.pending_bookings = data.pending_bookings || 0;
                        this.warmStats.pending_applications = data.pending_applications || 0;
                        this.behavioralMetrics.average_score = data.behavioral_scores?.average_score || 0;
                        this.behavioralMetrics.high_score_count = data.behavioral_scores?.high_score_count || 0;
                        this.hotLeads = data.behavioral_scores?.high_score_count || 0;
                        this.sidebarCounts.hot_leads = this.hotLeads;
                        this.sidebarCounts.pending_applications = data.pending_applications || 0;
                        this.loadingOpportunities = false;
                    } catch (error) {
                        console.error('Failed to fetch hot stats:', error);
                        this.loadingOpportunities = false;
                    }
                },
                
                async fetchWarmStats() {
                    try {
                        const response = await fetch('/api/stats/warm');
                        const data = await response.json();
                        this.dailyStats.conversion_rate = data.conversion_rate || 0;
                        this.funnelMetrics = data.funnel_metrics || {};
                        this.leadSources = data.lead_sources || [];
                        this.sidebarCounts.total_leads = data.total_leads || 0;
                        this.sidebarCounts.warm_leads = data.warm_leads || 0;
                        this.sidebarCounts.confirmed_bookings = data.confirmed_bookings || 0;
                        this.sidebarCounts.closing_pipeline = data.closing_pipeline || 0;
                    } catch (error) {
                        console.error('Failed to fetch warm stats:', error);
                    }
                },
                
                async fetchDailyStats() {
                    try {
                        const response = await fetch('/api/stats/daily');
                        const data = await response.json();
                        this.dailyStats.applications_count = data.applications_count || 0;
                        this.dailyStats.yesterday_applications = data.yesterday_applications || 0;
                    } catch (error) {
                        console.error('Failed to fetch daily stats:', error);
                    }
                },
                
                async fetchBehavioralIntelligence() {
                    try {
                        const response = await fetch('/api/v1/behavioral/dashboard');
                        const data = await response.json();
                        const analysis = data.behavioral_analysis || {};
                        this.activeTriggers = analysis.triggers || [];
                        this.identifiedPatterns = analysis.patterns || [];
                        if (analysis.summary) {
                            this.behavioralMetrics.medium_score_leads = analysis.summary.total_leads - analysis.summary.high_score_leads || 0;
                            this.behavioralMetrics.conversions_this_month = analysis.summary.conversions_this_month || 0;
                            this.behavioralMetrics.prediction_accuracy = analysis.summary.prediction_accuracy || 0;
                        }
                    } catch (error) {
                        console.error('Failed to fetch behavioral intelligence:', error);
                    }
                },
                
                async fetchFunnel() {
                    try {
                        const response = await fetch('/api/v1/behavioral/funnel?days=30');
                        const data = await response.json();
                        this.funnelData = data;
                    } catch (error) {
                        console.error('Failed to fetch funnel:', error);
                    }
                },
                
                async fetchTrends() {
                    try {
                        const response = await fetch(`/api/v1/behavioral/trends?metric=all&days=${this.trendsTimeRange}`);
                        const data = await response.json();
                        this.trendsData = data.trends || {};
                        this.renderTrendsChart();
                    } catch (error) {
                        console.error('Failed to fetch trends:', error);
                    }
                },
                
                async fetchBehavioralSegments() {
                    try {
                        const response = await fetch('/api/v1/behavioral/segments');
                        const data = await response.json();
                        this.behavioralSegments = data.segments || [];
                    } catch (error) {
                        console.error('Failed to fetch segments:', error);
                    }
                },
                
                async fetchHeatmap() {
                    try {
                        const response = await fetch('/api/v1/behavioral/heatmap?days=30');
                        const data = await response.json();
                        this.heatmapData = data.heatmap || [];
                    } catch (error) {
                        console.error('Failed to fetch heatmap:', error);
                    }
                },
                
                async fetchHoustonMarket() {
                    try {
                        const response = await fetch('/api/v1/behavioral/houston-market');
                        const data = await response.json();
                        this.houstonMarket = data.houston_market_intelligence || [];
                    } catch (error) {
                        console.error('Failed to fetch Houston market:', error);
                    }
                },
                
                async fetchAIRecommendations() {
                    try {
                        const response = await fetch('/api/v1/behavioral/recommendations?status=pending&limit=20');
                        const data = await response.json();
                        this.aiRecommendations = data.recommendations || [];
                    } catch (error) {
                        console.error('Failed to fetch AI recommendations:', error);
                    }
                },
                
                async fetchAnomalies() {
                    try {
                        const response = await fetch('/api/v1/behavioral/anomalies?severity=all&limit=10');
                        const data = await response.json();
                        this.behavioralAnomalies = data.anomalies || [];
                    } catch (error) {
                        console.error('Failed to fetch anomalies:', error);
                    }
                },
                
                async fetchPropertyStats() {
                    try {
                        const response = await fetch('/api/v1/admin/properties/stats');
                        const data = await response.json();
                        this.propertyStats = data.data || {};
                        this.sidebarCounts.active_properties = this.propertyStats.active_properties || 0;
                        this.sidebarCounts.pending_images = this.propertyStats.pending_properties || 0;
                    } catch (error) {
                        console.error('Failed to fetch property stats:', error);
                    }
                },
                
                async fetchTodaySchedule() {
                    try {
                        const response = await fetch('/api/v1/schedule/today');
                        const data = await response.json();
                        this.todaySchedule = data;
                    } catch (error) {
                        console.error('Failed to fetch today schedule:', error);
                    }
                },
                
                async fetchSystemHealth() {
                    try {
                        const response = await fetch('/api/v1/bi/system/health');
                        const data = await response.json();
                        this.systemHealth = data;
                    } catch (error) {
                        console.error('Failed to fetch system health:', error);
                    }
                },
                
                async fetchRealtimeStats() {
                    try {
                        const response = await fetch('/api/v1/bi/realtime/stats');
                        const data = await response.json();
                        this.realtimeStats = data;
                    } catch (error) {
                        console.error('Failed to fetch realtime stats:', error);
                    }
                },
                
                async fetchEmailStats() {
                    try {
                        const response = await fetch('/api/v1/email/stats?days=30');
                        const data = await response.json();
                        this.emailStats = data.data || {};
                    } catch (error) {
                        console.error('Failed to fetch email stats:', error);
                    }
                },
                
                async fetchWebhookStats() {
                    try {
                        const response = await fetch('/api/v1/webhooks/stats');
                        const data = await response.json();
                        this.webhookStats = data;
                    } catch (error) {
                        console.error('Failed to fetch webhook stats:', error);
                    }
                },
                
                async fetchPreListingStats() {
                    try {
                        const response = await fetch('/api/v1/pre-listing/stats');
                        const data = await response.json();
                        this.preListingStats = data.data || {};
                    } catch (error) {
                        console.error('Failed to fetch pre-listing stats:', error);
                    }
                },
                
                async fetchHARStats() {
                    try {
                        const response = await fetch('/api/v1/market-data/stats');
                        const data = await response.json();
                        this.harStats = data.stats || {};
                    } catch (error) {
                        console.error('Failed to fetch HAR stats:', error);
                    }
                },
                
                async fetchRecentActivity() {
                    try {
                        const response = await fetch('/api/v1/activity/recent?limit=12');
                        const data = await response.json();
                        this.recentActivity = data.activities || [];
                    } catch (error) {
                        console.error('Failed to fetch recent activity:', error);
                    }
                },
                startPolling() {
                    this.liveStatsInterval = setInterval(() => this.fetchLiveStats(), 15000);
                    this.hotStatsInterval = setInterval(() => this.fetchHotStats(), 300000);
                    this.warmStatsInterval = setInterval(() => this.fetchWarmStats(), 3600000);
                    this.activityInterval = setInterval(() => this.fetchRecentActivity(), 30000);
                    setInterval(() => this.fetchRealtimeStats(), 10000);
                },
                
                toggleActivityPolling() {
                    this.activityPolling = !this.activityPolling;
                },
                
                async refreshOpportunities() {
                    this.loadingOpportunities = true;
                    await this.fetchHotStats();
                },
                
                async executeInsightAction(insightId, action) {
                    if (action.method === 'GET') {
                        window.location.href = action.endpoint;
                    } else if (action.method === 'POST') {
                        try {
                            await fetch(action.endpoint, { method: 'POST' });
                            window.showToast('success', `Executed: ${action.label}`);
                            this.dashboardInsights = this.dashboardInsights.filter(i => i.id !== insightId);
                        } catch (error) {
                            window.showToast('error', 'Failed to execute action');
                        }
                    }
                },
                
                getInsightAlertClass(type) {
                    const classes = { 'success': 'alert-success', 'warning': 'alert-warning', 'info': 'alert-info', 'critical': 'alert-danger' };
                    return classes[type] || 'alert-info';
                },
                
                getInsightIcon(type) {
                    return '';
                },
                
                getPriorityBadgeClass(priority) {
                    if (priority >= 4) return 'badge-danger';
                    if (priority >= 3) return 'badge-warning';
                    return 'badge-info';
                },
                
                async executeAction(oppId, action, leadEmail) {
                    this.executingAction = oppId + '-' + action;
                    try {
                        await new Promise(resolve => setTimeout(resolve, 800));
                        window.showToast('success', `Executed "${action}" for ${leadEmail}`);
                    } catch (error) {
                        window.showToast('error', 'Failed to execute action');
                    } finally {
                        this.executingAction = null;
                    }
                },
                
                async executeRecommendation(recId, action) {
                    window.showToast('info', `Executing: ${action}`);
                },
                
                async dismissRecommendation(recId) {
                    this.aiRecommendations = this.aiRecommendations.filter(r => r.id !== recId);
                    window.showToast('success', 'Recommendation dismissed');
                },
                
                async acknowledgeAnomaly(anomalyId) {
                    this.behavioralAnomalies = this.behavioralAnomalies.filter(a => a.id !== anomalyId);
                    window.showToast('success', 'Anomaly acknowledged');
                },
                
                async triggerHARScrape() {
                    this.scrapingHAR = true;
                    try {
                        const response = await fetch('/api/v1/market-data/scrape', { method: 'POST' });
                        const data = await response.json();
                        window.showToast('success', `HAR scraping initiated. ETA: ${data.estimated}`);
                    } catch (error) {
                        window.showToast('error', 'Failed to trigger scraping');
                    } finally {
                        setTimeout(() => { this.scrapingHAR = false; }, 2000);
                    }
                },
                
                renderCharts() {
                    this.$nextTick(() => {
                        this.renderTrendsChart();
                        this.renderSegmentsChart();
                        this.renderBookingTrendsChart();
                        this.renderBookingSourcesChart();
                        this.renderLeadSourceChart();
                        this.renderPropertyTypeChart();
                    });
                },
                
                renderTrendsChart() {
                    if (this.trendsChart) this.trendsChart.destroy();
                    const ctx = this.$refs.trendsChart;
                    if (!ctx) return;
                    const labels = this.trendsData.active_users?.map(t => new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })) || [];
                    this.trendsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Active Users', data: this.trendsData.active_users?.map(t => t.value) || [], borderColor: 'rgb(43, 75, 115)', backgroundColor: 'rgba(43, 75, 115, 0.1)', tension: 0.4 },
                                { label: 'Engagement', data: this.trendsData.engagement?.map(t => t.value) || [], borderColor: 'rgb(196, 169, 98)', backgroundColor: 'rgba(196, 169, 98, 0.1)', tension: 0.4 },
                                { label: 'Conversions', data: this.trendsData.conversions?.map(t => t.value) || [], borderColor: 'rgb(16, 185, 129)', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
                    });
                },
                
                renderSegmentsChart() {
                    if (this.segmentsChart) this.segmentsChart.destroy();
                    const ctx = this.$refs.segmentsChart;
                    if (!ctx) return;
                    this.segmentsChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: this.behavioralSegments.map(s => s.segment.replace('_', ' ')),
                            datasets: [{ data: this.behavioralSegments.map(s => s.lead_count), backgroundColor: ['rgb(16, 185, 129)', 'rgb(245, 158, 11)', 'rgb(59, 130, 246)', 'rgb(156, 163, 175)'] }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                },
                
                renderBookingTrendsChart() {
                    const ctx = this.$refs.bookingTrendsChart;
                    if (!ctx) return;
                    this.bookingTrendsChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Bookings', data: [8, 12, 6, 15, 9, 11, 13], borderColor: 'rgb(43, 75, 115)', tension: 0.4 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                    this.timeSlots = [
                        { time: '9:00 AM', bookings: 23, popularity: 85 },
                        { time: '10:00 AM', bookings: 31, popularity: 95 },
                        { time: '11:00 AM', bookings: 28, popularity: 90 },
                        { time: '2:00 PM', bookings: 35, popularity: 100 },
                        { time: '3:00 PM', bookings: 29, popularity: 88 },
                        { time: '4:00 PM', bookings: 26, popularity: 82 }
                    ];
                },
                
                renderBookingSourcesChart() {
                    const ctx = this.$refs.bookingSourcesChart;
                    if (!ctx) return;
                    this.bookingSourcesChart = new Chart(ctx, {
                        type: 'pie',
                        data: { labels: ['Website', 'Phone', 'Email', 'Referral'], datasets: [{ data: [45, 28, 15, 12], backgroundColor: ['rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)', 'rgb(239, 68, 68)'] }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                },
                
                renderLeadSourceChart() {
                    const ctx = this.$refs.leadSourceChart;
                    if (!ctx) return;
                    this.leadSourceChart = new Chart(ctx, {
                        type: 'bar',
                        data: { labels: this.leadSources.map(s => s.source), datasets: [{ label: 'Leads', data: this.leadSources.map(s => s.count), backgroundColor: 'rgba(43, 75, 115, 0.8)' }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                },
                
                renderPropertyTypeChart() {
                    const ctx = this.$refs.propertyTypeChart;
                    if (!ctx) return;
                    this.propertyTypeChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: ['Single Family', 'Townhouse', 'Condo', 'Multi-Family'], datasets: [{ data: [45, 28, 18, 9], backgroundColor: ['rgb(43, 75, 115)', 'rgb(196, 169, 98)', 'rgb(16, 185, 129)', 'rgb(59, 130, 246)'] }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                },
                
                getHeatmapColor(day, hour) {
                    const cell = this.heatmapData.find(c => c.day_of_week === day && c.hour === hour);
                    if (!cell) return 'rgb(243, 244, 246)';
                    const intensity = cell.intensity;
                    const r = Math.round(43 + (239 - 43) * (1 - intensity));
                    const g = Math.round(75 + (68 - 75) * (1 - intensity));
                    const b = Math.round(115 + (68 - 115) * (1 - intensity));
                    return `rgb(${r}, ${g}, ${b})`;
                },
                
                getHeatmapActivity(day, hour) {
                    const cell = this.heatmapData.find(c => c.day_of_week === day && c.hour === hour);
                    return cell?.activity || 0;
                },
                
                getDayName(day) {
                    return ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][day];
                },
                
                getWebhookStatusCount(status) {
                    const stat = this.webhookStats.status_breakdown?.find(s => s.status === status);
                    return stat?.count || 0;
                },
                
                getActivityIconPath(type) {
                    const paths = {
                        'lead': 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z',
                        'property': 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6',
                        'booking': 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z',
                        'application': 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
                        'email': 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z',
                        'system': 'M13 10V3L4 14h7v7l9-11h-7z'
                    };
                    return paths[type] || paths['system'];
                },
                
                calculateConversionRate(numerator, denominator) {
                    if (!denominator || denominator === 0) return '0%';
                    return ((numerator / denominator) * 100).toFixed(1) + '%';
                },
                
                performSearch() {
                    if (this.searchQuery.length < 2) return;
                    console.log('Searching:', this.searchQuery);
                },
                
                getOpportunityClass(type) {
                    if (type === 'hot_lead') return 'hot';
                    if (type === 're_engagement') return 'warm';
                    return 'info';
                },
                
                getActionButtonClass(action) {
                    const map = { 'send_email': 'btn-primary', 'schedule_showing': 'btn-success', 'make_call': 'btn-warning', 'send_sms': 'btn-info' };
                    return map[action] || 'btn-secondary';
                },
                
                getSeverityBadge(severity) {
                    const map = { 'high': 'badge-danger', 'medium': 'badge-warning', 'low': 'badge-info' };
                    return map[severity] || 'badge-info';
                },
                
                getActivityColor(type) {
                    const colors = { 'lead': 'rgb(43, 75, 115)', 'booking': 'rgb(16, 185, 129)', 'application': 'rgb(196, 169, 98)', 'property': 'rgb(59, 130, 246)', 'email': 'rgb(156, 163, 175)', 'system': 'rgb(107, 114, 128)' };
                    return colors[type] || 'rgb(156, 163, 175)';
                },
                
                formatStageName(stage) {
                    return stage.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                },
                
                formatDemographic(demo) {
                    return demo.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                },
                
                formatAttribute(attr) {
                    return attr.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                },
                
                formatTime(seconds) {
                    if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
                    if (seconds < 86400) return `${Math.round(seconds / 3600)}h`;
                    return `${Math.round(seconds / 86400)}d`;
                },
                
                formatTimeAgo(timestamp) {
                    if (!timestamp) return '-';
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diff = (now - date) / 1000;
                    if (diff < 60) return 'Just now';
                    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
                    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
                    if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
                    return date.toLocaleDateString();
                },
                
                formatCurrency(amount) {
                    if (!amount) return '$0';
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
                }
            };
        }
        
        function statCard(metric) {
            return {
                displayValue: 0,
                target: 0,
                animationFrame: null,
                
                init() {
                    this.startCountUp();
                },
                
                startCountUp() {
                    this.$watch('$parent.liveStats.' + metric, (newValue) => {
                        this.target = newValue || 0;
                        this.animateCountUp();
                    });
                    this.$watch('$parent.hotLeads', (newValue) => {
                        if (metric === 'hot_leads') {
                            this.target = newValue || 0;
                            this.animateCountUp();
                        }
                    });
                },
                
                animateCountUp() {
                    const duration = 1000;
                    const startValue = this.displayValue;
                    const endValue = this.target;
                    const change = endValue - startValue;
                    const startTime = performance.now();
                    const animate = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        this.displayValue = startValue + (change * progress);
                        if (progress < 1) {
                            this.animationFrame = requestAnimationFrame(animate);
                        } else {
                            this.displayValue = endValue;
                        }
                    };
                    if (this.animationFrame) cancelAnimationFrame(this.animationFrame);
                    this.animationFrame = requestAnimationFrame(animate);
                }
            };
        }
        
        function toastManager() {
            return {
                toasts: [],
                nextId: 1,
                show(type, message, duration = 5000) {
                    const id = this.nextId++;
                    const toast = { id, type, message, visible: true };
                    this.toasts.push(toast);
                    setTimeout(() => { this.remove(id); }, duration);
                },
                remove(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index > -1) {
                        this.toasts[index].visible = false;
                        setTimeout(() => { this.toasts.splice(index, 1); }, 300);
                    }
                },
                getToastIcon(type) {
                    return '';
                }
            };
        }
        
        window.showToast = function(type, message, duration) {
            const toastContainer = document.querySelector('[x-data="toastManager()"]');
            if (toastContainer && Alpine.$data(toastContainer)) {
                Alpine.$data(toastContainer).show(type, message, duration);
            }
        };
        
        window.formatCurrency = function(amount) {
            if (!amount) return '$0';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        };
    </script>
</body>
</html>
