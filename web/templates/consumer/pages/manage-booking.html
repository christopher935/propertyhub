<!DOCTYPE html>

<html lang="en">
{{template "_head.html" .}}
<body class="scout-consumer-layout page-manage-booking">
<!-- SVG Icon Sprite -->
{{template "_svg_sprite.html"}}
<!-- Navigation -->
{{template "_nav.html" .}}
<!-- Main Content -->
<main>
<!-- Hero Section -->
<section class="section">
<div class="container">
<div class="hero-header">
<h1 class="text-heading-1 text-navy mb-4">Manage Your Booking</h1>
<p class="text-body-lg text-gray-600">View details and make changes to your property tour</p>
</div>

            {{if .Booking}}
            <!-- Two Column Layout -->
<div class="contact-grid">
<!-- Left Column: Booking Details -->
<div class="form-stack">
<!-- Booking Details Card -->
<div class="card">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<h2 class="text-heading-2 text-navy">Booking Details</h2>
<span class="badge badge-{{.Booking.StatusClass}}">
                                {{.Booking.Status}}
                            </span>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
<div>
<p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 4px;">Booking ID</p>
<p style="font-size: 1rem; color: var(--navy-primary); font-weight: 600; margin: 0;">{{.Booking.ID}}</p>
</div>
<div>
<p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 4px;">Property</p>
<p style="font-size: 1rem; color: var(--navy-primary); font-weight: 600; margin: 0;">{{.Booking.PropertyAddress}}</p>
</div>
<div>
<p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 4px;">Tour Date</p>
<p style="font-size: 1rem; color: var(--navy-primary); font-weight: 600; margin: 0;">
<svg height="16" style="display: inline-block; vertical-align: middle; margin-right: 4px;" width="16"><use href="#icon-calendar"></use></svg>
                                    {{.Booking.TourDate}}
                                </p>
</div>
<div>
<p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 4px;">Tour Time</p>
<p style="font-size: 1rem; color: var(--navy-primary); font-weight: 600; margin: 0;">
<svg height="16" style="display: inline-block; vertical-align: middle; margin-right: 4px;" width="16"><use href="#icon-clock"></use></svg>
                                    {{.Booking.TourTime}}
                                </p>
</div>
<div>
<p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 4px;">Contact Name</p>
<p style="font-size: 1rem; color: var(--navy-primary); font-weight: 600; margin: 0;">
<svg height="16" style="display: inline-block; vertical-align: middle; margin-right: 4px;" width="16"><use href="#icon-user"></use></svg>
                                    {{.Booking.ContactName}}
                                </p>
</div>
<div>
<p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 4px;">Contact Email</p>
<p style="font-size: 1rem; color: var(--navy-primary); font-weight: 600; margin: 0;">
<svg height="16" style="display: inline-block; vertical-align: middle; margin-right: 4px;" width="16"><use href="#icon-envelope"></use></svg>
                                    {{.Booking.ContactEmail}}
                                </p>
</div>
<div>
<p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 4px;">Contact Phone</p>
<p style="font-size: 1rem; color: var(--navy-primary); font-weight: 600; margin: 0;">
<svg height="16" style="display: inline-block; vertical-align: middle; margin-right: 4px;" width="16"><use href="#icon-phone"></use></svg>
                                    {{.Booking.ContactPhone}}
                                </p>
</div>
<div>
<p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 4px;">Created</p>
<p style="font-size: 1rem; color: var(--navy-primary); font-weight: 600; margin: 0;">{{.Booking.CreatedAt}}</p>
</div>
</div>

                        {{if .Booking.Notes}}
                        <div style="margin-top: 24px; padding: 16px; background: var(--gray-50); border-radius: 8px;">
<h3 class="text-heading-3 text-navy mb-2">Additional Notes</h3>
<p style="color: var(--gray-700); margin: 0;">{{.Booking.Notes}}</p>
</div>
                        {{end}}
                    </div>
<!-- Property Preview Card -->
                    {{if .Property}}
                    <div class="card">
<h2 class="text-heading-2 text-navy mb-8">Property Information</h2>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            {{if .Property.ImageURL}}
                            <div style="grid-column: 1 / -1;">
<img alt="{{.Property.Address}}" src="{{.Property.ImageURL}}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 12px;"/>
</div>
                            {{end}}
                            <div style="grid-column: 1 / -1;">
<h3 class="text-heading-3 text-navy mb-2">{{.Property.Address}}</h3>
<p style="color: var(--gray-600); margin-bottom: 16px;">
<svg height="16" style="display: inline-block; vertical-align: middle; margin-right: 4px;" width="16"><use href="#icon-map-pin"></use></svg>
                                    {{.Property.City}}, {{.Property.State}} {{.Property.Zip}}
                                </p>
<div style="display: flex; gap: 16px; margin-bottom: 16px;">
<span style="padding: 8px 16px; background: var(--gray-100); border-radius: 8px; font-size: 0.875rem; color: var(--gray-700);">{{.Property.Bedrooms}} bed</span>
<span style="padding: 8px 16px; background: var(--gray-100); border-radius: 8px; font-size: 0.875rem; color: var(--gray-700);">{{.Property.Bathrooms}} bath</span>
<span style="padding: 8px 16px; background: var(--gray-100); border-radius: 8px; font-size: 0.875rem; color: var(--gray-700);">{{.Property.SquareFeet}} sq ft</span>
</div>
<p style="font-size: 1.75rem; color: var(--gold-primary); font-weight: 700; margin-bottom: 16px;">${{.Property.Rent}}/month</p>
<a class="btn btn-secondary" href="/property/{{.Property.ID}}">View Full Details</a>
</div>
</div>
</div>
                    {{end}}
                </div>
<!-- Right Column: Actions -->
<div style="display: flex; flex-direction: column; gap: 24px;">
                    
                    {{if eq .Booking.Status "confirmed"}}
                    <!-- Manage Booking Card -->
<div style="background: var(--white); padding: 32px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);">
<h3 class="text-heading-3 text-navy mb-6">Manage Booking</h3>
<div style="display: flex; flex-direction: column; gap: 12px;">
<button class="btn btn-primary btn-block" onclick="showRescheduleModal()" type="button">
<svg class="icon" height="20" width="20"><use href="#icon-calendar"></use></svg>
                                Reschedule Tour
                            </button>
<button class="btn btn-secondary btn-block" onclick="showCancelModal()" type="button">
<svg class="icon" height="20" width="20"><use href="#icon-x-circle"></use></svg>
                                Cancel Booking
                            </button>
</div>
</div>
                    {{end}}

                    <!-- Help Card -->
<div style="background: var(--gold-50); padding: 32px; border-radius: 16px; border: 2px solid var(--gold-200);">
<div style="text-align: center; margin-bottom: 16px;">
<svg height="48" style="color: var(--gold-primary);" width="48"><use href="#icon-info"></use></svg>
</div>
<h3 class="text-heading-3 text-navy text-center mb-4">Need Help?</h3>
<p style="color: var(--gray-700); text-align: center; margin-bottom: 16px;">Contact us for assistance with your booking</p>
<div style="text-align: center;">
<p style="font-weight: 600; color: var(--navy-primary); margin-bottom: 8px;">
<svg height="16" style="display: inline-block; vertical-align: middle; margin-right: 4px;" width="16"><use href="#icon-phone"></use></svg>
                                (281) 925-7222
                            </p>
<p style="font-weight: 600; color: var(--navy-primary);">
<svg height="16" style="display: inline-block; vertical-align: middle; margin-right: 4px;" width="16"><use href="#icon-envelope"></use></svg>
                                tours@landlordsoftexas.com
                            </p>
</div>
</div>
</div>
</div>

            {{else}}
            <!-- No Booking Found -->
<div style="max-width: 600px; margin: 0 auto;">
<div style="background: var(--white); padding: 64px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); text-align: center;">
<svg height="80" style="color: var(--gray-400); margin-bottom: 24px;" width="80"><use href="#icon-x-circle"></use></svg>
<h2 class="text-heading-2 text-navy mb-4">Booking Not Found</h2>
<p style="color: var(--gray-600); margin-bottom: 32px;">We couldn't find a booking with the provided information.</p>
<a class="btn btn-primary" href="/properties">Browse Properties</a>
</div>
</div>
            {{end}}
        </div>
</section>
</main>
<!-- Reschedule Modal -->
<div class="modal" id="reschedule-modal">
<div class="modal-backdrop" onclick="closeRescheduleModal()"></div>
<div class="modal-wrapper">
<div class="modal-container">
<div class="modal-header">
<h3 class="modal-title">Reschedule Tour</h3>
<button class="modal-close" onclick="closeRescheduleModal()" type="button">
<svg class="modal-close-icon" height="24" width="24"><use href="#icon-x"></use></svg>
</button>
</div>
<form id="reschedule-form">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
<div class="modal-content">
<div class="form-group">
<label class="form-label" for="new-date">New Tour Date</label>
<input class="form-input" id="new-date" name="new_date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label" for="new-time">New Tour Time</label>
<select class="form-select" id="new-time" name="new_time" required="">
<option value="">Select a time</option>
<option value="09:00">9:00 AM</option>
<option value="10:00">10:00 AM</option>
<option value="11:00">11:00 AM</option>
<option value="13:00">1:00 PM</option>
<option value="14:00">2:00 PM</option>
<option value="15:00">3:00 PM</option>
<option value="16:00">4:00 PM</option>
</select>
</div>
<div class="form-group">
<label class="form-label" for="reschedule-reason">Reason (Optional)</label>
<textarea class="form-textarea" id="reschedule-reason" name="reason" rows="3"></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeRescheduleModal()" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Confirm Reschedule</button>
</div>
</form>
</div>
</div>
</div>
<!-- Cancel Modal -->
<div class="modal" id="cancel-modal">
<div class="modal-backdrop" onclick="closeCancelModal()"></div>
<div class="modal-wrapper">
<div class="modal-container">
<div class="modal-header">
<h3 class="modal-title">Cancel Booking</h3>
<button class="modal-close" onclick="closeCancelModal()" type="button">
<svg class="modal-close-icon" height="24" width="24"><use href="#icon-x"></use></svg>
</button>
</div>
<form id="cancel-form">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
<div style="padding: 24px;">
<div class="alert alert-danger" style="margin-bottom: 24px;">
<h4 style="color: var(--red-700); font-weight: 600; margin-bottom: 8px;">Are you sure?</h4>
<p style="color: var(--red-600); font-size: 0.875rem; margin: 0;">This action cannot be undone. You will need to create a new booking if you change your mind.</p>
</div>
<div class="form-group">
<label class="form-label" for="cancel-reason">Cancellation Reason (Optional)</label>
<textarea class="form-textarea" id="cancel-reason" name="reason" rows="3"></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeCancelModal()" type="button">Keep Booking</button>
<button class="btn btn-primary btn-danger" type="submit">Cancel Booking</button>
</div>
</form>
</div>
</div>
</div>
<!-- Footer -->
{{template "_footer.html"}}
<script>
function showRescheduleModal() {
    const modal = document.getElementById('reschedule-modal');
    const backdrop = modal.querySelector('.modal-backdrop');
    const wrapper = modal.querySelector('.modal-wrapper');
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    requestAnimationFrame(() => {
        if (backdrop) backdrop.classList.add('show');
        if (wrapper) wrapper.classList.add('show');
    });
}

function closeRescheduleModal() {
    const modal = document.getElementById('reschedule-modal');
    const backdrop = modal.querySelector('.modal-backdrop');
    const wrapper = modal.querySelector('.modal-wrapper');
    
    if (backdrop) backdrop.classList.remove('show');
    if (wrapper) wrapper.classList.remove('show');
    
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }, 200);
}

function showCancelModal() {
    const modal = document.getElementById('cancel-modal');
    const backdrop = modal.querySelector('.modal-backdrop');
    const wrapper = modal.querySelector('.modal-wrapper');
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    requestAnimationFrame(() => {
        if (backdrop) backdrop.classList.add('show');
        if (wrapper) wrapper.classList.add('show');
    });
}

function closeCancelModal() {
    const modal = document.getElementById('cancel-modal');
    const backdrop = modal.querySelector('.modal-backdrop');
    const wrapper = modal.querySelector('.modal-wrapper');
    
    if (backdrop) backdrop.classList.remove('show');
    if (wrapper) wrapper.classList.remove('show');
    
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }, 200);
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const rescheduleModal = document.getElementById('reschedule-modal');
        const cancelModal = document.getElementById('cancel-modal');
        
        if (rescheduleModal && rescheduleModal.style.display === 'flex') {
            closeRescheduleModal();
        }
        if (cancelModal && cancelModal.style.display === 'flex') {
            closeCancelModal();
        }
    }
});

// Form submissions
document.getElementById('reschedule-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = {
        booking_id: '{{.Booking.ID}}',
        new_date: document.getElementById('new-date').value,
        new_time: document.getElementById('new-time').value,
        reason: document.getElementById('reschedule-reason').value
    };
    
    try {
        const response = await fetch('/api/booking/reschedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            alert('Your tour has been rescheduled successfully!');
            location.reload();
        } else {
            alert('Failed to reschedule. Please try again or contact us.');
        }
    } catch (error) {
        console.error('Reschedule error:', error);
        alert('An error occurred. Please contact us at (281) 925-7222.');
    }
});

document.getElementById('cancel-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = {
        booking_id: '{{.Booking.ID}}',
        reason: document.getElementById('cancel-reason').value
    };
    
    try {
        const response = await fetch('/api/booking/cancel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            alert('Your booking has been cancelled.');
            window.location.href = '/properties';
        } else {
            alert('Failed to cancel booking. Please try again or contact us.');
        }
    } catch (error) {
        console.error('Cancel error:', error);
        alert('An error occurred. Please contact us at (281) 925-7222.');
    }
});
</script>
</body>
</html>
