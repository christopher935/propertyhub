name: Deploy to Digital Ocean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Droplet
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build PropertyHub
        run: |
          echo "üî® Building PropertyHub..."
          GOOS=linux GOARCH=amd64 CGO_ENABLED=1 go build \
            -ldflags="-w -s -X main.Version=${{ github.sha }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o propertyhub \
            ./cmd/server
          
          chmod +x propertyhub
          ls -lh propertyhub
          echo "‚úÖ Build complete: $(./propertyhub --version 2>&1 | head -1 || echo 'Binary created')"

      - name: Validate Build
        run: |
          echo "üß™ Validating binary..."
          file propertyhub
          if ldd propertyhub 2>&1 | grep -q "not found"; then
            echo "‚ùå Missing dependencies"
            exit 1
          fi
          echo "‚úÖ Binary validation passed"

      - name: Deploy to Digital Ocean
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          DB_PASSWORD: ${{ secrets.DO_DB_PASSWORD }}
        run: |
          echo "üîê Configuring SSH..."
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 209.38.116.238 >> ~/.ssh/known_hosts
          
          echo "üì¶ Creating backup..."
          ssh -i ~/.ssh/deploy_key root@209.38.116.238 << 'ENDSSH'
            cd /opt/propertyhub
            BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            
            # Backup current binary and templates
            if [ -f propertyhub ]; then
              cp propertyhub "$BACKUP_DIR/"
            fi
            if [ -d web/templates ]; then
              cp -r web/templates "$BACKUP_DIR/"
            fi
            if [ -d web/static ]; then
              cp -r web/static "$BACKUP_DIR/"
            fi
            
            # Keep only last 5 backups
            ls -dt backups/*/ 2>/dev/null | tail -n +6 | xargs rm -rf || true
            
            echo "‚úÖ Backup created: $BACKUP_DIR"
          ENDSSH
          
          echo "üì§ Uploading new binary..."
          scp -i ~/.ssh/deploy_key propertyhub root@209.38.116.238:/opt/propertyhub/propertyhub.new
          
          echo "üåê Syncing web assets (rsync creates directories)..."
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
            web/templates/ root@209.38.116.238:/opt/propertyhub/web/templates/
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
            web/static/ root@209.38.116.238:/opt/propertyhub/web/static/
          
          echo "üóÑÔ∏è Running database migrations..."
          scp -i ~/.ssh/deploy_key -r internal/database/migrations root@209.38.116.238:/opt/propertyhub/
          
          ssh -i ~/.ssh/deploy_key root@209.38.116.238 << ENDSSH
            export PGPASSWORD="$DB_PASSWORD"
            
            echo "Applying migrations..."
            for migration in /opt/propertyhub/migrations/*.sql; do
              if [ -f "\$migration" ]; then
                echo "  ‚Üí \$(basename \$migration)"
                psql -h llot-db-do-user-24934977-0.e.db.ondigitalocean.com \
                     -p 25060 \
                     -U doadmin \
                     -d defaultdb \
                     -f "\$migration" 2>&1 | grep -v "already exists" || true
              fi
            done
            
            echo "‚úÖ Migrations complete"
          ENDSSH
          
          echo "üîÑ Deploying application..."
          ssh -i ~/.ssh/deploy_key root@209.38.116.238 << 'ENDSSH'
            cd /opt/propertyhub
            
            # Atomic swap
            mv propertyhub.new propertyhub
            chmod +x propertyhub
            
            # Restart service
            systemctl restart propertyhub
            
            echo "‚úÖ Service restarted"
          ENDSSH

      - name: Health Check
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DO_SSH_PRIVATE_KEY }}
        run: |
          echo "üè• Performing health check..."
          
          # Wait for service to initialize (DB connections, templates, etc.)
          echo "‚è≥ Waiting 15 seconds for service initialization..."
          sleep 15
          
          # Check systemd status first
          echo "üîç Checking systemd service status..."
          ssh -i ~/.ssh/deploy_key root@209.38.116.238 << 'ENDSSH'
            if systemctl is-active --quiet propertyhub; then
              echo "‚úÖ Service is active"
            else
              echo "‚ùå Service is not running"
              echo "Last 20 log lines:"
              journalctl -u propertyhub -n 20 --no-pager
              exit 1
            fi
          ENDSSH
          
          # Now check HTTP endpoint
          echo "üåê Checking HTTP health endpoint..."
          for i in {1..12}; do
            RESPONSE=$(curl -s -m 5 http://209.38.116.238:8080/health || echo "")
            if echo "$RESPONSE" | grep -q '"status":"ok"'; then
              echo "‚úÖ Health check PASSED!"
              echo "Response: $RESPONSE"
              exit 0
            fi
            echo "‚è≥ Attempt $i/12... waiting 5 seconds"
            sleep 5
          done
          
          echo "‚ùå Health check failed after 12 attempts (60 seconds)"
          echo "üìã Fetching service logs..."
          ssh -i ~/.ssh/deploy_key root@209.38.116.238 'journalctl -u propertyhub -n 50 --no-pager'
          exit 1

      - name: Rollback on Failure
        if: failure()
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DO_SSH_PRIVATE_KEY }}
        run: |
          echo "üîÑ Rolling back to last known good state..."
          ssh -i ~/.ssh/deploy_key root@209.38.116.238 << 'ENDSSH'
            cd /opt/propertyhub
            LATEST_BACKUP=$(ls -dt backups/*/ 2>/dev/null | head -n 1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              echo "üì¶ Restoring from: $LATEST_BACKUP"
              
              # Restore binary
              if [ -f "${LATEST_BACKUP}/propertyhub" ]; then
                cp "${LATEST_BACKUP}/propertyhub" propertyhub
                echo "‚úÖ Binary restored"
              fi
              
              # Restore templates
              if [ -d "${LATEST_BACKUP}/templates" ]; then
                rm -rf web/templates
                cp -r "${LATEST_BACKUP}/templates" web/templates
                echo "‚úÖ Templates restored"
              fi
              
              # Restore static files
              if [ -d "${LATEST_BACKUP}/static" ]; then
                rm -rf web/static
                cp -r "${LATEST_BACKUP}/static" web/static
                echo "‚úÖ Static files restored"
              fi
              
              # Restart with old version
              systemctl restart propertyhub
              sleep 5
              
              if systemctl is-active --quiet propertyhub; then
                echo "‚úÖ Rollback successful - service is running"
              else
                echo "‚ùå Rollback failed - service still not running"
                journalctl -u propertyhub -n 30 --no-pager
              fi
            else
              echo "‚ö†Ô∏è No backup found to rollback to"
            fi
          ENDSSH
